const UMS=[{id:1,en:"Weight",it:"Peso",msu:"kg",isu:"lb",convert:e=>2.2*e},{id:2,en:"Length",it:"Lunghezza",msu:"m",isu:"ft",convert:e=>3.28*e},{id:3,en:"Length",it:"Lunghezza",msu:"cm",isu:"in",convert:e=>.39*e},{id:4,en:"Pressure",it:"Pressione",msu:"bar",isu:"psi",convert:e=>14.50377*e},{id:5,en:"Power",it:"Potenza attiva",msu:"kW",isu:"hp",convert:e=>1.34102*e},{id:6,en:"Temperature",it:"Temperatura",msu:"°C",isu:"°F",convert:e=>5*e/9+32},{id:7,en:"Flow rate",it:"Portata",msu:"l/min",isu:"gpm",convert:e=>.264172*e},{id:9,en:"Current",it:"Corrente",msu:"A"},{id:10,en:"Speed of rotation",it:"Velocità di rotazione",msu:"rpm"},{id:11,en:"Power",it:"Pressione sonora",msu:"dB/(A)"},{id:12,en:"Volume",it:"Volume",msu:"m³",isu:"ft³",convert:e=>35.3147*e},{id:13,en:"Percentage",it:"Percentuale",msu:"%"},{id:14,en:"Power",it:"Potenza",msu:"Watt",isu:"hp",convert:e=>.00134102*e},{id:15,en:"Flow rate",it:"Portata",msu:"l/min",isu:"cfm",convert:e=>.035314*e},{id:16,en:"Voltage",it:"Tensione",msu:"V"},{id:17,en:"Volume",it:"Volume",msu:"l",isu:"gal",convert:e=>.264172*e},{id:18,en:"Frequency",it:"Frequenza",msu:"Hz"},{id:19,en:"Time",it:"Tempo",msu:"min"},{id:20,en:"Length",it:"Lunghezza",msu:"mm",isu:"mils",convert:e=>39.3701*e},{id:21,en:"Time",it:"Tempo",msu:"sec"},{id:23,en:"Flow rate",it:"Portata",msu:"m³/h",isu:"cfm",convert:e=>.588578*e},{id:24,en:"Force",it:"Forza",msu:"N/m",isu:"lb/f",convert:e=>.737562*e},{id:28,en:"Length",it:"Lunghezza",msu:"mm",isu:"inch",convert:e=>.0393701*e},{id:29,en:"Apparent power",it:"Potenza apparente",msu:"kVA",isu:"HP",convert:e=>.7355*e},{id:30,en:"Short circuit current",it:"Corrente di corto circuito",msu:"kA"},{id:31,en:"Voltage AC",it:"Tensione AC",msu:"VAC"},{id:32,en:"Voltage DC",it:"Tensione DC",msu:"VDC"},{id:33,en:"Flow rate",it:"Portata",msu:"m³/min",isu:"cfm",convert:e=>35.315*e},{id:34,en:"Number",it:"Numero",msu:"N°"},{id:35,en:"Phase",it:"Fase",msu:"ph"},{id:36,it:"Vibrazioni",msu:"mm/sec",isu:"IPS",convert:e=>.0393701*e}];class kvParams extends HTMLElement{static observedAttributes=["schema","data","mode","um","sheet","lang","columns","template"];static#e={type:{en:"Type",it:"Tipo"},label:{en:"Label",it:"Etichetta"},um:{en:"U.M.",it:"U.M."},flags:{en:"Attributes",it:"Attributi"},number:{en:"Number",it:"Numero"},text:{en:"Text",it:"Testo"},date:{en:"Date",it:"Data"},select:{en:"Selection",it:"Selezione"},checkbox:{en:"Checkbox",it:"Checkbox"},textarea:{en:"Notes",it:"Note"},group:{en:"Group",it:"Gruppo"},separator:{en:"Line",it:"Linea"},delete:{en:"You sure you want to delete the parameter?",it:"Sicuri di voler eliminare il parametro?"},optionless:{en:"Options are not applicabile to $1 parameters.",it:"Le opzioni non sono applicabili ai parametri $1."},tests:{en:"Test",it:"Test"},testRemove:{en:"Sure you want to delete the test?",it:"Sicuri di voler eliminare il test?"},na:{en:"Allow Not Applicable (NA)",it:"Consenti Non Applicabile (NA)"},decimals:{en:"Decimals",it:"Decimali"},save:{en:"Save",it:"Salva"},pair:{en:"Pair",it:"Accoppia"},new:{en:"New parameter",it:"Nuovo parametro"}};static#t=[{en:"Described",it:"Descrittivo",icon:"fas fa-font"},{en:"Searched",it:"Ricercabile",icon:"fas fa-search"},{en:"",it:"",icon:""},{en:"Imported",it:"Importato",icon:"fas fa-file-download"},{en:"Technical sheet",it:"Scheda tecnica",icon:"fas fa-drafting-compass"},{en:"Sales sheet",it:"Scheda commerciali",icon:"fas fa-handshake"},{en:"Production sheet",it:"Scheda produzione",icon:"fas fa-tools"},{en:"Test sheet",it:"Scheda collaudo",icon:"fas fa-tachometer-alt"},{en:"Logistics sheet",it:"Scheda logistica",icon:"fas fa-truck-loading"},{en:"Plate",it:"Targa",icon:"fas fa-qrcode"},{en:"Required",it:"Obbligatorio",icon:"fas fa-exclamation"}];Schema=[];Data={};Mode="show";Sheet=4;Columns=1;UM="msu";Lang="it";static findId(e,t){return e.find((e=>e.id==t))}static sizeArray(e=[],t=1){return t<=e.length?e.slice(0,t):e.concat(new Array(t-e.length).fill(null))}constructor(){super(),this.Schema=JSON.parse(this.innerText||"[]"),this.addEventListener("mouseup",(e=>{const t=e.target;if(t.closest("kv-params tbody")?.querySelector(".selected")?.classList.remove("selected"),t.closest("kv-params tbody")&&t.closest("tr")?.classList.add("selected"),t.classList.contains("tests")){const e=this.querySelectorAll("tfoot th").length+1;if(e>4)return;this.querySelector("thead th[colspan]").setAttribute("colspan",e-1);const t=this.querySelectorAll("tbody>tr").length;this.querySelectorAll("tbody>tr").forEach((a=>{if(a.children[0].hasAttribute("colspan"))a.children[0].setAttribute("colspan",e);else{const e=a.lastElementChild.cloneNode(!0);e.children[0].value="",e.children[0].checked=!1,e.children[0].setAttribute("tabindex",t+parseInt(e.children[0].getAttribute("tabindex"))),a.lastElementChild.insertAdjacentElement("afterend",e)}})),e>2&&(this.querySelector("tfoot tr").lastElementChild.innerText="",this.querySelector("tfoot tr").lastElementChild.insertAdjacentHTML("afterend",'<th><i class="far fa-trash-alt testRemove"></i></th>'))}else if(t.classList.contains("testRemove")){if(!confirm(kvParams.#e.testRemove[this.Lang]))return;const e=this.querySelectorAll("tfoot th").length-1;this.querySelector("thead [colspan]").setAttribute("colspan",e),this.querySelectorAll("tbody>tr").forEach((t=>{t.children[0].hasAttribute("colspan")?t.children[0].setAttribute("colspan",e):t.lastElementChild.remove()})),2==e?this.querySelector("tfoot tr").lastElementChild.remove():this.querySelector("tfoot tr").lastElementChild.previousElementSibling.remove()}else if(t.classList.contains("add")){this.#a(t.closest("tr")).scrollIntoView({block:"nearest"})}else if(t.classList.contains("remove")&&1!=t.closest("tbody")?.children.length&&(e.ctrlKey||confirm(kvParams.#e.delete[this.Lang])))t.closest("tr").remove();else if(t.classList.contains("manageOptions"))this.#s(e);else if("flags"==t.getAttribute("name")){t.classList.toggle("deselected");const e=parseInt(t.closest("td").children[0].value);t.closest("td").children[0].value=t.classList.contains("deselected")?e&~(1<<t.getAttribute("value")):e|1<<t.getAttribute("value")}else if(t.classList.contains("range")){const e=[isNaN(parseFloat(t.form.min.value))?null:parseFloat(t.form.min.value),isNaN(parseFloat(t.form.max.value))?null:parseFloat(t.form.max.value),isNaN(parseInt(t.form.decimals.value))?null:parseInt(t.form.decimals.value),t.form.flag.checked];t.options.hasAttribute("range")?(t.options.setAttribute("range",JSON.stringify(e)),t.options.setAttribute("min",e[0]),t.options.setAttribute("max",e[1]),t.options.setAttribute("step",null==e[2]?"any":Math.pow(10,-e[2]))):t.options.value=JSON.stringify(e);const a=e||kvParams.findId(this.Schema,t.getAttribute("ref").replace("P","")).options,s=this.querySelector(`[title="${t.getAttribute("ref").replace("P","@")}"] span`);s&&(s.innerHTML=this.#i(a)),t.closest("dialog").remove()}else t.classList.contains("options")?(t.options.value=t.form.options.value,t.closest("dialog").remove()):t.dataset.flag&&(t.classList.contains("set")?(t.classList.remove("set"),this.querySelectorAll("tbody>tr").forEach((e=>e.style.display=""))):(this.querySelectorAll("th i.set").forEach((e=>e.classList.remove("set"))),t.classList.toggle("set"),this.querySelectorAll("tbody input[name=flags]").forEach((e=>{e.closest("tr").style.display=parseInt(e.value)&1<<parseInt(t.dataset.flag)&&t.classList.contains("set")?"":"none"}))),document.cookie=`kvParamsSheet=${parseInt(t.getAttribute("data-flag"))||4}; path=/; max-age=31536000; SameSite=Strict`)})),this.addEventListener("focusin",(e=>{const t=e.target;this?.querySelector("tbody tr.selected")?.classList.remove("selected"),t.closest("tbody")&&t.closest("tr")?.classList.add("selected")})),this.addEventListener("focusout",this.querySelector("tbody tr.selected")?.classList.remove("selected")),document.addEventListener("keyup",(e=>{if("Enter"==e.key&&e.target.classList.contains("manageOptions"))this.#s(e);else if("manage"==this.Mode&&e.altKey&&("ArrowUp"==e.key||"ArrowDown"==e.key)){const t=this.querySelector("tbody tr.selected");if("ArrowUp"==e.key&&t.previousElementSibling){let e=t.previousElementSibling;for(;"none"==e?.style.display;)e=e.previousElementSibling;t.parentNode.insertBefore(t,e)}else if(t.nextElementSibling){let e=t.nextElementSibling;for(;"none"==e?.style.display;)e=e.nextElementSibling;t.parentNode.insertBefore(e||t.parentNode.children[0],t)}}}))}async#n(e,t){"schema"==e&&0==this.Schema.length?await fetch(t).then((e=>e.json())).then((e=>this.Schema=e||[])).catch((()=>this.Schema=[])):"data"==e&&await fetch(t).then((e=>e.json())).then((e=>this.Data=e||{})).catch((()=>this.Data={}))}async attributeChangedCallback(e,t,a){switch("show"!=t&&"show"!=this.Mode&&this.save(),e){case"sheet":this.Sheet=parseInt(a);break;case"lang":this.Lang=a;break;case"um":this.UM=a;break;case"schema":case"data":await this.#n(e,a);break;case"mode":this.Mode=a;break;case"columns":this.Columns=a||1}if("mode"!=e&&(e="mode",a=this.Mode||"show"),this.innerHTML="","manage"==a){const e=document.cookie.split("; ").find((e=>e.startsWith("kvParamsSheet=")));if(e){const t=parseInt(e.split("=")[1]);isNaN(t)||(this.Sheet=t)}this.#l()}else this.#r(a,this.getAttribute("template"))}#l(){const e=`<input type="hidden" name="${this.getAttribute("name")}"><table class="schema"><thead><tr><th>${kvParams.#e.type[this.Lang]}</th><th style="width:100%">${kvParams.#e.label[this.Lang]}</th><th>${kvParams.#e.um[this.Lang]}</th><th></th><th style="white-space:nowrap">${kvParams.#t.map(((e,t)=>`<i class="${e.icon}" title="${e[this.Lang]}" data-flag="${t}"></i>`)).join(" ")}</th><th></th></tr></thead><tbody><tr><td><input form="kv-params" type="hidden" name="id"><select form="kv-params" title="Type" name="type"><option value="number">${kvParams.#e.number[this.Lang]}</option><option value="text">${kvParams.#e.text[this.Lang]}</option><option value="date">${kvParams.#e.date[this.Lang]}</option><option value="select">${kvParams.#e.select[this.Lang]}</option><option value="checkbox">${kvParams.#e.checkbox[this.Lang]}</option><option value="textarea">${kvParams.#e.textarea[this.Lang]}</option><option value="group">${kvParams.#e.group[this.Lang]}</option><option value="separator">${kvParams.#e.separator[this.Lang]}</option></select></td><td><input form="kv-params" name="label" title="Label" data-value="${JSON.stringify({en:kvParams.#e.new[0],it:kvParams.#e.new[1]})}" style="width: -webkit-fill-available" value="${kvParams.#e.new[this.Lang]}"></td><td><select form="kv-params" name="um" title="UM"><option></option>`+UMS.map((e=>`<option value="${e.id}">${e.msu} ${e.isu?.replace(/(.*)/," [$1]")||""}</option>`)).join("")+'</select></td><td><input form="kv-params" type="hidden" name="options"><i class="fas fa-sliders-h manageOptions" ref="options" tabindex="0"></i></td><td style="white-space:nowrap"><input form="kv-params" type="hidden" name="flags">'+kvParams.#t.map(((e,t)=>`<i class="${e.icon} deselected" name="flags" value="${t}" title="${e[this.Lang]}" tabindex="0"></i>`)).join(" ")+'</td><td style="white-space:nowrap"><i class="far fa-trash-alt remove" tabindex="0"></i> <i class="fas fa-plus add" tabindex="0"></i></td></tr></body></table>';this.insertAdjacentHTML("afterbegin",e),this.querySelector(`i[data-flag="${this.Sheet}"]`)?.classList.toggle("set"),this.Schema.forEach((e=>{const t=this.#a(this.querySelector("tbody>tr:last-child"));t.style.display=e.flags&1<<this.Sheet?"":"none",t.setAttribute("title","@"+e.id),t.querySelectorAll("input,select").forEach((a=>{if("label"==a.name)a.dataset.value=JSON.stringify(e.label),a.value=e.label[this.Lang];else if("flags"==a.name){a.value=e.flags;for(let a=0;a<kvParams.#t.length;++a)e.flags&1<<a?t.querySelector(`i[name="flags"][value="${a}"]`).classList.remove("deselected"):t.querySelector(`i[name="flags"][value="${a}"]`).classList.add("deselected")}else"options"==a.name?(a.value=JSON.stringify(e.options),""==e.options.join("")?a.nextElementSibling.classList.remove("set"):a.nextElementSibling.classList.add("set")):"checkbox"==a.type?a.checked=0!=(e[a.name]&1<<parseInt(a.value)):a.value=e[a.name]}))})),this.Schema.length>0&&this.querySelector("tbody>tr").remove(),this.children[0].value=JSON.stringify(this.Schema),this.scrollIntoView({block:"nearest"})}#a(e){const t=e.cloneNode(!0);return t.querySelector("select").value="number",t.querySelector('input[name="id"]').value=this.Schema.reduce(((e,t)=>Math.max(e,parseInt(t.id))),0)+1,t.querySelector('input[name="label"]').setAttribute("data-value",JSON.stringify(kvParams.#e.new)),t.querySelector('input[name="label"]').value=kvParams.#e.new[this.Lang],t.querySelector('select[name="um"]').value="",t.querySelector('input[name="options"]').value="",e.insertAdjacentElement("afterend",t),e.classList.remove("selected"),t}#s(e){const t=e.target.closest("tr"),a=kvParams.findId(UMS,t.querySelector("[name=um]")?.value||e.target.getAttribute("um"));t.closest("tbody").querySelector(".selected")?.classList.remove("selected"),t.closest("tbody").classList.add("selected"),t.classList.add("selected");let s,i,n="";switch(t.querySelector("[name=type]")?.value||"number"){case"number":if("options"==e.target.getAttribute("ref"))s=JSON.parse(t.querySelector('[name="options"]')?.value||"[null, null, null, null]");else{i=kvParams.findId(this.Schema,e.target.getAttribute("ref").substring(1));try{s=JSON.parse(t.querySelector(`[name=${e.target.getAttribute("ref")}]`)?.getAttribute("range"))||i?.options}catch{s=i?.options}}s[0]=isNaN(parseFloat(s[0]))?"":parseFloat(s[0]),s[1]=isNaN(parseFloat(s[1]))?"":parseFloat(s[1]),s[2]=isNaN(parseInt(s[2]))?"":parseInt(s[2]),s[3]=s[3]||"",n='<dialog id="kv-params-dialog" onkeydown="if (event.key==\'Escape\') this.close()" onclose="this.remove()"><header onclick="this.closest(\'dialog\').close()">',t.querySelector("[name=label]")?n+=`${t.querySelector("[name=label]").value} +  [${a?.msu}]`:n+=t.children[0].innerText,n+=`</header><form><label><span>Min</span> <input type="number" name="min" step="any" value="${s[0]}"></label><label><span>Max</span> <input type="number" name="max" step="any" value="${s[1]}"></label><label><span>${kvParams.#e.decimals[this.Lang]}</span> <input type="number" name="decimals" min="0" max="5" step="1" value="${s[2]}"></label><p style="margin:0.5rem 0"><label><input type="checkbox" name="flag" ${s[3]?"checked":""}> ${kvParams.#e.na[this.Lang]}</label></p><button type="button" class="range" ref="${e.target.getAttribute("ref")}" id="kv-params-options" style="float:right">${kvParams.#e.save[this.Lang]}</button></form></dialog>`;break;case"select":try{s=JSON.parse(t.querySelector("[name=options]").value||'["", ""]')}catch{s=[t.querySelector("[name=options]").value,""]}n=`<dialog id="kv-params-dialog" onkeydown="if (event.key=='Escape') this.close()" onclose="this.remove()"><header onclick="this.closest('dialog').close()">${t.querySelector("[name=label]").value}</header><form><kv-pair name="options" src="${t.querySelector("[name=options]").value.replaceAll('"',"&quot;")}" labels="${a?a.msu+","+a.isu:"en,it"}"></kv-pair><input type="checkbox" ${s[1]?"checked":""} onchange="this.previousElementSibling.setAttribute('pair', this.checked)"><label> ${kvParams.#e.pair[this.Lang]}</label><br><button type="button" ref="${e.target.getAttribute("ref")}" class="options" id="kv-params-options" style="float:right">${kvParams.#e.save[this.Lang]}</button></form></dialog>`;break;default:return void alert(kvParams.#e.optionless[this.Lang].replace("$1",t.querySelector("[name=type]").value))}n&&(this.insertAdjacentHTML("beforeend",n),document.getElementById("kv-params-options").options=t.querySelector("[name=options]")||e.target.previousElementSibling,document.getElementById("kv-params-dialog").showModal())}#r(e,t){if(document.getElementById(t))return void this.#o(e,document.getElementById(t));const a=parseInt(this.getAttribute("sheet"))||5;let s=1,i="";this.Schema.forEach((t=>{t.flags&1<<a&&("range"!=e||"range"==e&&"number"==t.type)&&(s=Math.max(s,this.Data[`P${t.id}`]?.length||1))}));const n=this.Schema.length;function l(e){const t=e.options;let a="";return"number"==e.type&&(a=`${isNaN(parseFloat(t[0]))?"":` min="${t[0]}"`}${isNaN(parseFloat(t[1]))?"":` max="${t[1]}"`}${isNaN(parseInt(t[2]))?' step="any"':` step="${Math.pow(10,-parseInt(t[2]))}"`}`),`name="P${e.id}"${0==(1024&e.flags)?"":" required"}${0==(8&e.flags)?"":" disabled"} ${a} form="kvParams"`}this.Schema.forEach(((t,r)=>{if(t.flags&1<<a&&("range"!=e||"range"==e&&"number"==t.type)){const a=kvParams.findId(UMS,t.um),o=t.um?"["+(a["edit"==e||"range"==e?"msu":this.UM]||a.msu)+"]":"",c=(1&t.flags?'<i class="fas fa-font"></i>':"")+(1&t.flags?'<i class="fas fa-search"></i>':"");let d,h;switch(t.type){case"number":d=this.Data[`PR${t.id}`]||[t.options]||[[null,null,null,null]],i+=`<tr><td title="@${t.id}">${t.label[this.Lang]} ${o} ${c}<span>${this.#i(d[0])}</span></td>`,kvParams.sizeArray(this.Data[`P${t.id}`],s).forEach(((s,o)=>{s=("show"==e&&"msu"!=this.UM&&"function"==typeof a?.convert?a.convert(s).toFixed(d[3]):s)||"",i+=`<td><input type="${"range"==e?"hidden":"number"}" ${l(t)} value="${s}" range="${JSON.stringify(d[o]).replaceAll('"',"&quot;")}" tabindex="${o*n+r}">`,"range"==e&&(i+=`<i class="fas fa-sliders-h manageOptions" ref="P${t.id}" um="${t.um}" tabindex="${o*n+r}"></i>`),i+="</td>"})),i+="</tr>";break;case"text":i+=`<tr><td title="@${t.id}">${t.label[this.Lang]}  ${c}</td>`,kvParams.sizeArray(this.Data[`P${t.id}`],s).forEach(((e,a)=>{i+=`<td><input ${l(t)} value="${e||""}" tabindex="${a*n+r}"></td>`})),i+="</tr>";break;case"date":i+=`<tr><td title="@${t.id}">${t.label[this.Lang]} ${c}</td>`,kvParams.sizeArray(this.Data[`P${t.id}`],s).forEach(((e,a)=>{i+=`<td><input type="date" ${l(t)} value="${e||""}" tabindex="${a*n+r}"></td>`})),i+="</tr>";break;case"checkbox":i+=`<tr><td title="@${t.id}">${t.label[this.Lang]} ${c}</td>`,kvParams.sizeArray(this.Data[`P${t.id}`],s).forEach(((e,a)=>{i+=`<td><input type="checkbox" ${l(t)} ${e?"checked":""} tabindex="${a*n+r}"></td>`})),i+="</tr>";break;case"select":{const d=t.options[0]?.split(",");let u=[];if("edit"===e)h=t.options[1]&&!t.um&&"en"!=this.Lang?1:0,t.um&&(u=t.options[1]?.split(",")||[]);else h=t.options[1]&&(t.um&&"isu"==this.UM||!t.um&&"en"!=this.Lang)?1:0;i+=`<tr><td title="@${t.id}">${t.label[this.Lang]} ${o} ${c}</td>`,kvParams.sizeArray(this.Data[`P${t.id}`],s).forEach(((e,s)=>{const o=d?.findIndex((t=>t==e));i+=`<td><select ${l(t)} tabindex="${s*n+r}"><option></option>${t.options[h]?.split(",").map(((e,t)=>`<option value="${d[t]}" ${o==t?" selected":""}>${e}${u[t]?" ["+u[t]+a.isu+"]":""}</option>`)).join("")}</select></td>`})),i+="</tr>";break}case"textarea":i+=`<tr><td colspan="*" title="@${t.id}"><label><span>${t.label[this.Lang]}${t.um?` [${t.um}]`:""} ${c}</span><textarea ${l(t)} tabindex="${r}">${value}</textarea></label></td></tr>`;break;case"separator":i+='<tr class="colspan"><td colspan="*">&nbsp;</td></tr>';break;case"group":i+=`<tr class="colspan"><td colspan="*">${t.label[this.Lang]}</td></tr>`}}})),i+=`</tbody><tfoot><tr>${"<th></th>".repeat(s)}<th>${7==a&&"edit"==e&&s>1?'<i class="far fa-trash-alt testRemove"></i>':""}</th></tr></tfoot>`,this.insertAdjacentHTML("afterbegin",`<div style="columns:${this.Columns};"><table class="test"><thead ${"manage"==e||7==a?"":'style="display:none"'}><tr><th style="width:100%;text-align:left" title="${kvParams.#t[a][this.Lang]}"></th><th${7!=a||"edit"!=e&&"range"!=e?` colspan="${s}">`:` class="tests" colspan="${s}">${kvParams.#e.tests[this.Lang]} <i class="fas fa-plus tests"></i>`}</th></tr></thead><tbody>`+i.replaceAll('colspan="*"',`colspan="${s+1}"`)+"</table></div>"),"show"==e&&this.querySelectorAll("input, textarea, select").forEach((e=>e.setAttribute("disabled","")))}#o(e,t){function a(e){const t=e.options;let a="";return"number"==e.type&&(a=`${isNaN(parseFloat(t[0]))?"":` min="${t[0]}"`}${isNaN(parseFloat(t[1]))?"":` max="${t[1]}"`}${isNaN(parseInt(t[2]))?' step="any"':` step="${Math.pow(10,-parseInt(t[2]))}"`}`),`name="P${e.id}"${0==(1024&e.flags)?"":" required"}${0==(8&e.flags)?"":" disabled"} ${a} form="kvParams"`}this.appendChild(document.importNode(t.content,!0)),"edit"!=e&&(e="show"),this.querySelectorAll('i[name^="P"]').forEach((t=>{const s=t.getAttribute("name"),i=kvParams.findId(this.Schema,parseInt(s.substring(1)));if(i){const n=kvParams.findId(UMS,i.um),l=i.um?"["+(n["edit"==e?"msu":this.UM]||n.msu)+"]":"",r=(1&i.flags?'<i class="fas fa-font"></i>':"")+(1&i.flags?'<i class="fas fa-search"></i>':"");let o,c;const d=this.Data[s]?this.Data[s][0]:"";switch(i.type){case"number":o=this.Data[`PR${i.id}`]||[i.options]||[[null,null,null,null]],d=("show"==e&&"msu"!=this.UM&&"function"==typeof n?.convert?n.convert(d).toFixed(o[3]):d)||"",t.insertAdjacentHTML("afterend",`<label title="@${i.id}"><span>${i.label[this.Lang]} ${l} ${r} ${this.#i(o[0])}</span><input ${a(i)} value="${d}" range="${JSON.stringify(o[k]).replaceAll('"',"&quot;")}"></label>`);break;case"text":t.insertAdjacentHTML("afterend",`<label title="@${i.id}"><span>${i.label[this.Lang]} ${l} ${r}</span> <input ${a(i)} value="${d||""}"></label>`);break;case"date":t.insertAdjacentHTML("afterend",`<label title="@${i.id}"><span>${i.label[this.Lang]} ${l} ${r}</span> <input type="date" ${a(i)} value="${d||""}"></label>`);break;case"checkbox":t.insertAdjacentHTML("afterend",`<label title="@${i.id}"><span>${i.label[this.Lang]} ${l} ${r}</span> <input type="checkbox" ${a(i)} ${d?"checked":""}></label>`);break;case"select":{const s=i.options[0]?.split(",");let o=[];if("edit"===e)c=i.options[1]&&!i.um&&"en"!=this.Lang?1:0,i.um&&(o=i.options[1]?.split(",")||[]);else c=i.options[1]&&(i.um&&"isu"==this.UM||!i.um&&"en"!=this.Lang)?1:0;const h=s?.findIndex((e=>e==d));t.insertAdjacentHTML("afterend",`<label title="@${i.id}"><span>${i.label[this.Lang]} ${l} ${r}</span><select ${a(i)}><option></option>${i.options[c]?.split(",").map(((e,t)=>`<option value="${s[t]}" ${h==t?" selected":""}>${e}${o[t]?" ["+o[t]+n.isu+"]":""}</option>`)).join("")}</select></label>`);break}case"textarea":t.insertAdjacentHTML("afterend",`<textarea ${a(i)}>${d}</textarea>`)}}t.remove()})),"show"==e&&this.querySelectorAll("input, textarea, select").forEach((e=>e.setAttribute("disabled","")))}#i(e){return`${isNaN(parseFloat(e[0]))?"(-∞,":`[${parseFloat(e[0]).toFixed(parseInt(e[2]))}, `} ${isNaN(parseFloat(e[1]))?"+∞)":`${parseFloat(e[1]).toFixed(parseInt(e[2]))}]`}${isNaN(parseInt(e[2]))?"":` ±${Math.pow(10,-parseInt(e[2]))}`}`}save(){if(null!=this.querySelector(".schema"))return this.Schema=[],this.querySelectorAll("tbody>tr").forEach(((e,t)=>{const a={};e.querySelectorAll("input,select").forEach((e=>{"label"==e.name?(a[e.name]=JSON.parse(e.dataset.value),a[e.name][this.Lang]=e.value):"options"==e.name?a.options=JSON.parse(e.value||"[]"):"flags"==e.name?a.flags=parseInt(e.value)||16:"id"==e.name?a.id=e.value||t:a[e.name]=e.value})),this.Schema.push(a)})),this.children[0].value=JSON.stringify(this.Schema),this.children[0].value;if("show"!=this.Mode){let e=this.querySelectorAll("tfoot>tr>th").length-1;return e=e<0?1:e,this.querySelectorAll("input, select, textarea").forEach(((t,a)=>{const s=a%e;s||(this.Data[t.name]=new Array(e),"number"!=t.type&&"hidden"!=t.type||(this.Data[t.name.replace("P","PR")]=new Array(e))),"checkbox"==t.type?this.Data[t.name][s]=t.checked?1<<parseInt(t.value):0:"number"==t.type||"hidden"==t.type?(this.Data[t.name][s]=parseFloat(t.value)||null,this.Data[t.name.replace("P","PR")][s]=kvParams.sizeArray(JSON.parse(t.getAttribute("range")),4)):t.hasAttribute("data-value")?(this.Data[t.name][s]=JSON.parse(t.dataset.value||'{"en":null,"it":null}'),this.Data[t.name][s][this.Lang]=t.value):this.Data[t.name][s]=t.value})),this.closest("form")&&this.getAttribute("name")&&this.closest("form")[this.getAttribute("name")]&&(this.closest("form")[this.getAttribute("name")].value=JSON.stringify(this.Data)),JSON.stringify(this.Data)}}}customElements.define("kv-params",kvParams);class kvPair extends HTMLElement{static observedAttributes=["src","pair","labels"];constructor(){super(),this.addEventListener("click",this.#c),this.addEventListener("keydown",this.#c),this.addEventListener("focusout",this.#c),this.addEventListener("focusin",this.#c),this.innerHTML=`<menu role="list" data-bit="0"><label></label></menu><menu role="list" data-bit="1"><label></label></menu><input type="hidden" name="${this.getAttribute("name")||"kv-pair"}">`,this.removeAttribute("name"),this.children[0].addEventListener("scroll",this.#c),this.children[0].addEventListener("scrollend",this.#c),this.children[1].addEventListener("scroll",this.#c),this.children[1].addEventListener("scrollend",this.#c)}async#n(e){return await fetch(e).then((e=>e.json())).then((e=>e)).catch((()=>["",""]))}async attributeChangedCallback(e,t,a){if(t==a)return;if("pair"==e)return this.setAttribute("pair","true"==a?"true":"false"),void(this.children[1].style.display="true"==a?"":"none");if("labels"==e)return this.children[0].querySelector("label").innerText=a.split(",")[0],void(this.children[1].querySelector("label").innerText=a.split(",")[1]);const s="["==a[0]?JSON.parse(a):await this.#n(a),i=(s[0]||"").split(","),n=(s[1]||"").split(","),l=Math.max(i.length,n.length);for(;i.length<l;)i.push("");for(;n.length<l;)n.push("");const r=this.getAttribute("labels")?.split(",")||["",""];this.children[0].innerHTML=`<label>${r[0]?r[0]:""}</label>`+i.map((e=>`<div role="listitem" contenteditable>${e}</div>`)).join(""),this.children[1].innerHTML=`<label>${r[1]?r[1]:""}</label>`+n.map((e=>`<div role="listitem" contenteditable>${e}</div>`)).join(""),s[1]||(this.children[1].style.display="none"),this.#d()}#c(e){if(e.key){if(-1==["Enter",",","Tab","ArrowDown","ArrowUp"].indexOf(e.key))return;e.preventDefault()}if("focusin"==e.type||"focusout"==e.type&&null==e.relatedTarget)return void this.querySelectorAll(".selected").forEach((e=>e.className=""));let t=e.relatedTarget||e.target;"scroll"!=e.type&&"scrollend"!=e.type&&"MENU"==t.tagName&&(t=t.lastChild,t.focus());const a=t.closest("menu")||this.querySelector("menu"),s=this.closest("kv-pair").querySelector(`menu[data-bit="${"0"==a.dataset.bit?"1":"0"}"]`);if("scroll"==e.type||"scrollend"==e.type)return void(s.scrollTop=a.scrollTop);this.querySelectorAll(".selected").forEach((e=>e.className=""));let i=0;for(;t.previousElementSibling;t=t.previousElementSibling,++i);switch(e.key){case"ArrowDown":i=i<a.children.length-1?i+2:2;case"ArrowUp":i=i>1?i-1:a.children.length-1,this.#h(a.children[i]),s.children[i].className="selected";break;case"Tab":this.#h(s.children[i]),s.children[i].className="",a.children[i].className="selected";break;case"Enter":a.insertAdjacentHTML("beforeend",'<div role="listitem" contenteditable></div>'),s.insertAdjacentHTML("beforeend",'<div role="listitem" contenteditable></div>'),i=a.children.length-1,this.#h(a.children[i]),s.children[i].className="selected";break;default:i&&i<s.children.length&&(s.children[i].className="selected")}this.#d(),s.scrollTop=a.scrollTop}#h(e){e.focus();const t=document.getSelection(),a=document.createRange();a.selectNodeContents(e),t.removeAllRanges(),t.addRange(a)}#d(){this.children[2].value=JSON.stringify([[...this.children[0].querySelectorAll('[role="listitem"]')].map((e=>e.innerText.replaceAll("\n",""))).join(",").replace(/,+$/g,""),[...this.children[1].querySelectorAll('[role="listitem"]')].map((e=>e.innerText.replaceAll("\n",""))).join(",").replace(/,+$/g,"")])}}customElements.define("kv-pair",kvPair);