class kvParams extends HTMLElement{static observedAttributes=["schema","data","mode","um","sheet","lang"];static#e={type:{en:"Type",it:"Tipo"},label:{en:"Label",it:"Etichetta"},um:{en:"U.M.",it:"U.M."},flags:{en:"Attributes",it:"Attributi"},number:{en:"Number",it:"Numero"},text:{en:"Text",it:"Testo"},date:{en:"Date",it:"Data"},select:{en:"Selection",it:"Selezione"},checkbox:{en:"Checkbox",it:"Checkbox"},textarea:{en:"Notes",it:"Note"},group:{en:"Group",it:"Gruppo"},separator:{en:"Line",it:"Linea"},delete:{en:"You sure you want to delete the paramter?",it:"Sicuri di voler eliminare il parametro?"},optionless:{en:"Options are not applicabile to $1 parameters.",it:"Le opzioni non sono applicabili ai parametri $1."},samples:{en:"Samples",it:"Misurazioni"},na:{en:"Allow Not Applicable (NA)",it:"Consenti Non Applicabile (NA)"},decimals:{en:"Decimals",it:"Decimali"},save:{en:"Save",it:"Salva"},pair:{en:"Pair",it:"Accoppia"}};static#t=[{en:"Described",it:"Descrittivo",icon:"fas fa-font"},{en:"Searched",it:"Ricercabile",icon:"fas fa-search"},{en:"",it:"",icon:""},{en:"Imported",it:"Importato",icon:"fas fa-wifi"},{en:"Technical sheet",it:"Dati tecnici",icon:"fas fa-drafting-compass"},{en:"Sales sheet",it:"Dati commerciali",icon:"fas fa-handshake"},{en:"Production sheet",it:"Dati produttivi",icon:"fas fa-tools"},{en:"Test sheet",it:"Dati collaudo",icon:"fas fa-tachometer-alt"},{en:"Logistics sheet",it:"Dati logistici",icon:"fas fa-truck-loading"},{en:"Plate",it:"Dati Targa",icon:"fas fa-qrcode"},{en:"Required",it:"Obbligatorio",icon:"fas fa-exclamation"}];Schema=[];Data={};UM="msu";Sheet=4;Lang="en";static findId(e,t){return e.find((e=>e.id==t))}constructor(){super(),this.Schema=JSON.parse(this.innerText||"[]"),this.addEventListener("mouseup",(e=>{const t=e.target;if(t.closest("tbody")?.querySelector(".selected")?.classList.remove("selected"),t.closest("tbody")&&t.closest("tr")?.classList.add("selected"),t.classList.contains("samples")){const e=this.querySelectorAll("tfoot th").length+1;this.querySelector("thead [colspan]").setAttribute("colspan",e),this.querySelectorAll("tbody tr").forEach((t=>{if(t.firstElementChild.hasAttribute("colspan"))t.firstElementChild.setAttribute("colspan",e);else{const e=t.lastElementChild.cloneNode(!0);e.firstElementChild.value="",e.firstElementChild.checked=!1,t.lastElementChild.insertAdjacentElement("afterend",e)}})),e>2&&(this.querySelector("tfoot tr").lastElementChild.innerText="",this.querySelector("tfoot tr").lastElementChild.insertAdjacentHTML("afterend",'<th><i class="far fa-trash-alt sampleRemove"></i></th>'))}else if(t.classList.contains("sampleRemove")){const e=this.querySelectorAll("tfoot th").length-1;this.querySelector("thead [colspan]").setAttribute("colspan",e),this.querySelectorAll("tbody tr").forEach((t=>{t.firstElementChild.hasAttribute("colspan")?t.firstElementChild.setAttribute("colspan",e):t.lastElementChild.remove()})),2==e?this.querySelector("tfoot tr").lastElementChild.remove():this.querySelector("tfoot tr").lastElementChild.previousElementSibling.remove()}else if(t.classList.contains("add")){this.#a(t.closest("tr")).scrollIntoView({block:"nearest"})}else if(t.classList.contains("remove")&&1!=t.closest("tbody")?.children.length&&(e.ctrlKey||confirm(kvParams.#e.delete[this.Lang])))t.closest("tr").remove();else if(t.classList.contains("manageOptions"))this.#s(e);else if("flags"==t.getAttribute("name")){t.classList.toggle("deselected");const e=parseInt(t.closest("td").firstElementChild.value);t.closest("td").firstElementChild.value=t.classList.contains("deselected")?e&~(1<<t.getAttribute("value")):e|1<<t.getAttribute("value")}else if(t.classList.contains("range")){const e=[parseInt(t.form.min.value)||null,parseInt(t.form.max.value)||null,parseInt(t.form.decimals.value)||null,t.form.flag.checked];t.options.hasAttribute("range")?(t.options.setAttribute("range",JSON.stringify(e)),t.options.setAttribute("min",e[0]),t.options.setAttribute("max",e[1]),t.options.setAttribute("step",null==e[2]?"any":Math.pow(10,-e[2]))):t.options.value=JSON.stringify(e),t.closest("dialog").remove()}else t.classList.contains("options")?(t.options.value=t.form.options.value,t.closest("dialog").remove()):t.dataset.flag&&(t.classList.contains("selected")?(t.classList.remove("selected"),this.querySelectorAll("tbody tr").forEach((e=>e.style.display=""))):(this.querySelectorAll("th i.selected").forEach((e=>e.classList.remove("selected"))),t.classList.toggle("selected"),this.querySelectorAll("tbody input[name=flags]").forEach((e=>{e.closest("tr").style.display=parseInt(e.value)&1<<parseInt(t.dataset.flag)&&t.classList.contains("selected")?"":"none"}))))})),this.addEventListener("focusin",(e=>{const t=e.target;this?.querySelector("tbody tr.selected")?.classList.remove("selected"),t.closest("tbody")&&t.closest("tr")?.classList.add("selected")})),this.addEventListener("focusout",this.querySelector("tbody tr.selected")?.classList.remove("selected")),document.addEventListener("keyup",(e=>{if("Enter"==e.key&&e.target.classList.contains("manageOptions"))this.#s(e);else if("manage"==this.getAttribute("mode")&&e.altKey&&("ArrowUp"==e.key||"ArrowDown"==e.key)){const t=this.querySelector("tbody tr.selected");if("ArrowUp"==e.key&&t.previousElementSibling){let e=t.previousElementSibling;for(;"none"==e?.style.display;)e=e.previousElementSibling;t.parentNode.insertBefore(t,e)}else if(t.nextElementSibling){let e=t.nextElementSibling;for(;"none"==e?.style.display;)e=e.nextElementSibling;t.parentNode.insertBefore(e||t.parentNode.firstElementChild,t)}}}));let e=this;for(;e&&!e.lang;)e=e.parentElement;this.Lang=kvParams.#t[0][e.lang]?e.lang.substring(0,2):"en"}async#i(e,t){"schema"==e&&0==this.Schema.length?await fetch(t).then((e=>e.json())).then((e=>this.Schema=e||[])).catch((()=>this.Schema=[])):"data"==e&&await fetch(t).then((e=>e.json())).then((e=>this.Data=e||{})).catch((()=>this.Data={}))}async attributeChangedCallback(e,t,a){switch(t&&this.save(),e){case"sheet":this.Sheet=parseInt(a);break;case"lang":this.Lang=a;break;case"um":this.UM=a;break;case"schema":case"data":await this.#i(e,a)}"mode"!=e&&(e="mode",a=this.getAttribute("mode")),this.innerHTML="","manage"==a?this.#l():this.#n(a)}#l(){const e=`<input type="hidden" name="${this.getAttribute("name")}"><table class="schema"><thead><tr><th>${kvParams.#e.type[this.Lang]}</th><th style="width:100%">${kvParams.#e.label[this.Lang]}</th><th>${kvParams.#e.um[this.Lang]}</th><th></th><th style="white-space:nowrap">${kvParams.#t.map(((e,t)=>`<i class="${e.icon}" title="${e[this.Lang]}" data-flag="${t}"></i>`)).join(" ")}</th><th></th></tr></thead><tbody><tr><td><input form="kv-params" type="hidden" name="id"><select form="kv-params" title="Type" name="type"><option value="number">${kvParams.#e.number[this.Lang]}</option><option value="text">${kvParams.#e.text[this.Lang]}</option><option value="date">${kvParams.#e.date[this.Lang]}</option><option value="select">${kvParams.#e.select[this.Lang]}</option><option value="checkbox">${kvParams.#e.checkbox[this.Lang]}</option><option value="textarea">${kvParams.#e.textarea[this.Lang]}</option><option value="group">${kvParams.#e.group[this.Lang]}</option><option value="separator">${kvParams.#e.separator[this.Lang]}</option></select></td><td><input form="kv-params" name="label" title="Label" data-value style="width: -webkit-fill-available"></td><td><select form="kv-params" name="um" title="UM"><option></option>`+UMS.map((e=>`<option value="${e.id}">${e.msu} ${e.isu?.replace(/(.*)/," [$1]")||""}</option>`)).join("")+'</select></td><td><input form="kv-params" type="hidden" name="options"><i class="fas fa-sliders-h manageOptions" ref="options" tabindex="0"></i></td><td style="white-space:nowrap"><input form="kv-params" type="hidden" name="flags">'+kvParams.#t.map(((e,t)=>`<i class="${e.icon}" name="flags" value="${t}" title="${e[this.Lang]}" tabindex="0"></i>`)).join(" ")+'</td><td style="white-space:nowrap"><i class="far fa-trash-alt remove" tabindex="0"></i> <i class="fas fa-plus add" tabindex="0"></i></td></tr></body></table>';this.insertAdjacentHTML("afterbegin",e),this.querySelector(`i[data-flag="${this.Sheet}"]`)?.classList.toggle("selected"),this.Schema.forEach((e=>{const t=this.#a(this.querySelector("tbody tr:last-child"));t.style.display=e.flags&1<<this.Sheet?"":"none",t.querySelectorAll("input,select").forEach((a=>{if("label"==a.name)a.dataset.value=JSON.stringify(e.label),a.value=e.label[this.Lang];else if("flags"==a.name){a.value=e.flags;for(let a=0;a<kvParams.#t.length;++a)e.flags&1<<a?t.querySelector(`i[name="flags"][value="${a}"]`).classList.remove("deselected"):t.querySelector(`i[name="flags"][value="${a}"]`).classList.add("deselected")}else"options"==a.name?a.value=JSON.stringify(e[a.name]):"checkbox"==a.type?a.checked=0!=(e[a.name]&1<<parseInt(a.value)):a.value=e[a.name]}))})),this.Schema.length>0&&this.querySelector("tbody tr").remove(),this.firstElementChild.value=JSON.stringify(this.Schema),this.scrollIntoView({block:"nearest"})}#a(e){const t=e.cloneNode(!0);return t.querySelector("input[name=id]").value="",e.insertAdjacentElement("afterend",t),t}#s(e){const t=e.target.closest("tr"),a=kvParams.findId(UMS,t.querySelector("[name=um]")?.value||e.target.getAttribute("um"));t.closest("tbody").querySelector(".selected")?.classList.remove("selected"),t.closest("tbody").classList.add("selected"),t.classList.add("selected");let s,i,l="";switch(t.querySelector("[name=type]")?.value||"number"){case"number":if("options"==e.target.getAttribute("ref"))s=JSON.parse(t.querySelector('[name="options"]')?.value||"[null, null, null, false]");else{i=kvParams.findId(this.Schema,e.target.getAttribute("ref").substring(1));try{s=JSON.parse(t.querySelector(`[name=${e.target.getAttribute("ref")}]`)?.getAttribute("range"))||i?.options}catch{s=i?.options}}s[0]=parseInt(s[0])||null,s[1]=parseInt(s[1])||null,s[2]=parseInt(s[2])||null,s[3]=s[3]||!1,l='<dialog id="kv-params-dialog" onkeydown="if (event.key==\'Escape\') this.close()" onclose="this.remove()"><header onclick="this.closest(\'dialog\').close()">',t.querySelector("[name=label]")?l+=`${t.querySelector("[name=label]").value} +  [${a?.msu}]`:l+=t.firstElementChild.innerText,l+=`</header><form><label><span>Min</span> <input type="number" name="min" step="any" value="${s[0]}"></label><label><span>Max</span> <input type="number" name="max" step="any" value="${s[1]}"></label><label><span>${kvParams.#e.decimals[this.Lang]}</span> <input type="number" name="decimals" min="0" max="5" step="1" value="${s[2]}"></label><p style="margin:0.5rem 0"><label><input type="checkbox" name="flag" ${s[3]?"checked":""}> ${kvParams.#e.na[this.Lang]}</label></p><button type="button" class="range" ref="${e.target.getAttribute("ref")}" id="kv-params-options" style="float:right">${kvParams.#e.save[this.Lang]}</button></form></dialog>`;break;case"select":try{s=JSON.parse(t.querySelector("[name=options]").value||'["", "", false]')}catch{s=[t.querySelector("[name=options]").value,"",!1]}l=`<dialog id="kv-params-dialog" onkeydown="if (event.key=='Escape') this.close()" onclose="this.remove()"><header onclick="this.closest('dialog').close()">${t.querySelector("[name=label]").value}</header><form><kv-pair name="options" src="${t.querySelector("[name=options]").value.replaceAll('"',"&quot;")}"></kv-pair><input type="checkbox" onchange="this.previousElementSibling.setAttribute('pair', this.checked)"><label> Pair</label><br><button type="button" ref="${e.target.getAttribute("ref")}" class="options" id="kv-params-options" style="float:right">${kvParams.#e.save[this.Lang]}</button></form></dialog>`;break;default:return void alert(kvParams.#e.optionless[this.Lang].replace("$1",t.querySelector("[name=type]").value))}l&&(this.insertAdjacentHTML("beforeend",l),document.getElementById("kv-params-options").options=t.querySelector("[name=options]")||e.target.previousElementSibling,document.getElementById("kv-params-dialog").showModal())}#n(e){const t=parseInt(this.getAttribute("sheet"))||5;let a=1,s="";function i(e){const t=e.options;let a="";return"number"==e.type&&(a=`${t[0]?` min="${t[0]}"`:""}${t[1]?` max="${t[1]}"`:""}${t[2]?` step="${Math.pow(10,-t[2])}"`:' step="any"'}`),`name="P${e.id}" ${0==(1024&e.flags)?"":"required"}${a} form="kvParams" tabindex="0"`}this.Schema.forEach((l=>{if(l.flags&1<<t&&("range"!=e||"range"==e&&"number"==l.type)){const t=kvParams.findId(UMS,l.um),n=l.um?"["+(t["edit"==e?"msu":this.UM]||t.msu)+"]":"";let r,o;switch(a=Math.max(a,this.Data[`P${l.id}`]?.length||1),l.type){case"number":r=this.Data[`PR${l.id}`]||l.options||[],s+=`<tr><td title="@${l.id}">${l.label[this.Lang]} ${n}</td>`,(this.Data[`P${l.id}`]||[null]).forEach((a=>{a=("view"==e&&"msu"!=this.UM&&"function"==typeof t?.convert?t.convert(a):a)||"",s+=`<td><input type="${"range"==e?"hidden":"number"}" ${i(l)} value="${a}" range="${JSON.stringify(r).replaceAll('"',"&quot;")}">`,"range"==e&&(s+=`<i class="fas fa-sliders-h manageOptions" ref="P${l.id}" um="${l.um}" tabindex="0"></i>`),s+="</td>"})),s+="</tr>";break;case"date":s+=`<tr><td title="@${l.id}">${l.label[this.Lang]}</td>`,(this.Data[`P${l.id}`]||[null]).forEach((e=>{s+=`<td><input type="date" ${i(l)} value="${e}"></td>`})),s+="</tr>";break;case"checkbox":s+=`<tr><td title="@${l.id}">${l.label[this.Lang]}</td>`,(this.Data[`P${l.id}`]||[null]).forEach((e=>{s+=`<td><input type="checkbox" ${i(l)} ${e?"checked":""}></td>`})),s+="</tr>";break;case"select":o="edit"==e?this.UM||"en"==this.Lang?0:1:"en"==this.Lang&&"isu"!=this.UM||!l.options[2]?0:1,s+=`<tr><td title="@${l.id}">${l.label[this.Lang]} ${n}</td>`,(this.Data[`P${l.id}`]||[null]).forEach((e=>{const t=l.options[0]?.split(",").findIndex((t=>t==e));s+=`<td><select ${i(l)}>${l.options[o]?.split(",").map(((e,a)=>`<option${t==a?" selected":""}>${e}</option>`)).join("")}</select></td>`})),s+="</tr>";break;case"textarea":s+=`<tr><td colspan="*" title="@${l.id}"><label><span>${l.label[this.Lang]}${l.um?` [${l.um}]`:""}</span><textarea ${i(l)}>${value}</textarea></label></td></tr>`;break;case"separator":s+='<tr class="colspan"><td colspan="*"><hr></td></tr>';break;case"group":s+=`<tr class="colspan"><td colspan="*">${l.label[this.Lang]}<hr></td></tr>`}}})),s+=`</tbody><tfoot><tr>${"<th></th>".repeat(a)}<th>${1==a?"":'<i class="far fa-trash-alt sampleRemove"></i>'}</th></tr></tfoot>`,this.insertAdjacentHTML("afterbegin",`<div><table class="test"><thead><tr><th style="width:100%;text-align:left"><i class="${kvParams.#t[t].icon}"></i> ${kvParams.#t[t][this.Lang]}</th><th${7==t?` class="samples" colspan="${a}">${kvParams.#e.samples[this.Lang]} <i class="fas fa-plus samples"></i>`:">"}</th></tr></thead><tbody>`+s.replaceAll('colspan="*"',`colspan="${a+1}"`)+"</table></div>"),"show"==e&&this.querySelectorAll("input, textarea, select").forEach((e=>e.setAttribute("disabled","")))}save(){if(null!=this.querySelector(".schema"))return this.Schema=[],this.querySelectorAll("tbody tr").forEach((e=>{const t={};e.querySelectorAll("input,select").forEach((e=>{"checkbox"==e.type?t[e.name]|=e.checked?1<<parseInt(e.value):0:"number"==e.type?t[e.name]=parseFloat(e.value):e.hasAttribute("data-value")?(t[e.name]=JSON.parse(e.dataset.value||'{"en":null,"it":null}'),t[e.name][this.Lang]=e.value):"options"==e.name?t.options=JSON.parse(e.value)||[]:"flags"==e.name?t.flags=parseInt(e.value):t[e.name]=e.value})),this.Schema.push(t)})),this.firstElementChild.value=JSON.stringify(this.Schema),this.firstElementChild.value;{const e=this.querySelectorAll("tfoot th").length-1;return this.querySelectorAll("input, select, textarea").forEach(((t,a)=>{const s=a%e;s||(this.Data[t.name]=new Array(e),"number"!=t.type&&"hidden"!=t.type||(this.Data[t.name.replace("P","PR")]=[])),"checkbox"==t.type?this.Data[t.name][s]=t.checked?1<<parseInt(t.value):0:"number"==t.type||"hidden"==t.type?(this.Data[t.name][s]=parseFloat(t.value)||null,this.Data[t.name.replace("P","PR")].push(JSON.parse(t.getAttribute("range"))[0])):t.hasAttribute("data-value")?(this.Data[t.name][s]=JSON.parse(t.dataset.value||'{"en":null,"it":null}'),this.Data[t.name][s][this.Lang]=t.value):this.Data[t.name][s]=t.value})),JSON.stringify(this.Data)}}}customElements.define("kv-params",kvParams);