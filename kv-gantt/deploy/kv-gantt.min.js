class kvGantt extends HTMLElement{static observedAttributes=["src","lang"];static#t={resource:{en:"Resource",it:"Risorsa"},operator:{en:"Operator",it:"Operatore"},task:{en:"Task",it:"Attività"},load:{en:"Load",it:"Carico"},department:{en:"Department",it:"Reparto"}};Data={name:null,date:new Date,resources:[],operators:[],tasks:[]};Lang="en";constructor(){super(),this.innerHTML=`<input type="hidden" name="${this.getAttribute("name")}"><table><thead><tr><th rowspan="2"></th><th rowspan="2">Load</th><th class="day"></th></tr><tr><th class="tasks"></th></tr></thead><tbody></tbody><tfoot><tr><td></td><td class="load"></td><td class="tasks"></td></tfoot></table>`,this.addEventListener("click",(t=>{const e=t.target;e.classList.contains("task")?alert(t.target.innerText):e.closest("tr[data-id")&&(this.querySelector("tr.selected")?.classList.remove("selected"),e.closest("tr").classList.add("selected"))}))}async#e(t){return await fetch(t).then((t=>t.json())).then((t=>t)).catch((()=>["",""]))}async attributeChangedCallback(t,e,a){switch(t){case"src":if(this.Data=await this.#e(a)||{name:null,date:new Date,resources:[],operators:[],tasks:[]},!this.Data.tasks.length)for(let t=0;t<20;++t){const e=Math.floor(this.Data.resources.length*Math.random()),a=Math.floor(this.Data.operators.length*Math.random());this.Data.tasks.push({id:t,name:kvGantt.#t.task[this.Lang],resource:this.Data.resources[e].id,operator:this.Data.operators[a].id,start:23*Math.random(),duration:4*Math.random()+1,progress:100*Math.random()})}break;case"lang":this.Lang=a}this.renderGantt(this.Data.resources,this.Data.operators,this.Data.tasks)}renderGantt(t=[],e=[],a=[]){const r={};e.forEach(((t,e)=>{r[t.id]=this.#a(e)})),this.querySelector("thead th:nth-child(2)").innerText=kvGantt.#t.load[this.Lang],this.querySelector("tfoot td:nth-child(1)").innerText=kvGantt.#t.load[this.Lang],this.querySelector(".day").innerText=new Date(this.Data.date).toLocaleDateString(void 0,{weekday:"long",year:"numeric",month:"long",day:"numeric"}),this.querySelector("tbody").innerHTML="";let s="";t.forEach(((t,o)=>{s!=t.department&&(s=t.department,this.querySelector("tbody").insertAdjacentHTML("beforeend",`<tr class="department"><td colspan="${3+this.Data.operators.length}">${kvGantt.#t.department[this.Lang]}: ${s}</td></tr>`)),t._work=0,this.querySelector("tbody").insertAdjacentHTML("beforeend",`<tr data-id="${t.id}"><td><span class="expand-symbol" title="Expand/Collapse">▶</span> ${t.name}</td><td class="load"></td><td class="tasks"></td></tr>`);let n="";e.filter((t=>t.work>0)).forEach((e=>{if(!o){const t=r[e.id];this.querySelector("thead tr").insertAdjacentHTML("beforeend",`\n\t\t\t\t\t\t<th rowspan="2" class="operator" style="background-color: ${t};">\n\t\t\t\t\t\t\t${e.name}\n\t\t\t\t\t\t</th>`)}e._work=a.reduce(((a,r)=>a+(r.resource==t.id&&r.operator==e.id?r.duration:0)),0),n+=`<td class="load">${(100*e._work/e.work).toFixed(0)}</td>`})),n=n.replace(/">0</g,' zero">0<'),this.querySelector("tbody tr:last-child").insertAdjacentHTML("beforeend",n)})),this.querySelectorAll(".tasks").forEach(((t,e)=>t.innerHTML=Array.from(Array(24).keys()).reduce(((t,a)=>t+`<div class="hour">${e?"&nbsp;":a+":00"}</div>`),""))),a.forEach((a=>{t.find((t=>t.id===a.resource))._work+=a.duration;const s=r[a.operator];this.querySelector(`tr[data-id="${a.resource}"] .tasks`).insertAdjacentHTML("afterbegin",`\n\t\t\t\t<div \n\t\t\t\t\tdata-id="${a.id}" \n\t\t\t\t\ttitle="${e.find((t=>t.id==a.operator)).name}" \n\t\t\t\t\tclass="task" \n\t\t\t\t\tstyle="left:${100*a.start/24}%; width:${100*a.duration/24}%; background-color:${s};">\n\t\t\t\t\t${a.name}\n\t\t\t\t\t<div \n\t\t\t\t\t\tclass="progress-bar" \n\t\t\t\t\t\tstyle="width:${a.progress}%; background-color: rgba(0, 0, 0, 0.2); height: 100%; position: absolute; top: 0; left: 0;">\n\t\t\t\t\t</div>\n\t\t\t\t</div>`)})),t.forEach((t=>{const e=this.querySelector(`tr[data-id="${t.id}"] .load`),a=Math.floor(t._work/t.work*100);e.innerText=a,0===a&&e.classList.add("zero")}));let o=[...this.querySelectorAll("tbody td:nth-child(2)")];this.querySelector("tfoot td:nth-child(2)").innerText=(o.reduce(((t,e)=>t+parseInt(e.innerText)),0)/o.length).toFixed(0);for(let t=0;t<this.Data.operators.length;++t)o=[...this.querySelectorAll(`tbody td:nth-child(${4+t})`)],this.querySelector("tfoot tr").insertAdjacentHTML("beforeend",`<td class="load">${o.reduce(((t,e)=>t+parseInt(e.innerText)),0)}</td>`);this.querySelectorAll("td.load").forEach((t=>{const e=parseInt(t.innerText,10)||0;t.style.background=this.#r(e)}));const n=Array(24).fill(0);a.forEach((t=>{const e=Math.floor(t.start),a=Math.min(24,Math.ceil(t.start+t.duration));for(let r=e;r<a;r++)n[r]+=t.duration/(a-e)}));const d=Math.max(...n),i=n.map((t=>t/d*100));this.querySelector("tfoot td:nth-child(3)").innerHTML=i.map((t=>`<div class="bar" style="background: ${this.#r(t)}">${t.toFixed(0)}%</div>`)).join("")}#r(t){let e;return e=t<=50?"#ffcccc":t<=80?"#ffe0b3":"#ccffcc",`linear-gradient(to right, ${e} ${t}%, transparent ${t}%)`}#a(t){const e=["#ff9999","#ffcc99","#ffff99","#ccff99","#99ff99","#99ffcc","#99ccff","#9999ff","#cc99ff","#ff99cc"];return e[t%e.length]}}customElements.define("kv-gantt",kvGantt);