async function kvSelect(e){if(!(e instanceof Element))return void document.querySelectorAll(".kvSelect").forEach((e=>kvSelect(e)));const t=e.dataset.key||"_id",s=JSON.parse(e.value).sort(((e,t)=>e.name<t.name?-1:1));s.sort(((e,t)=>(e.selected?"*":"")+e.name<(t.selected?"*":"")+t.name?-1:1));const r=document.createElement("ol");r.className="kvSelect",r.setAttribute("start",0),r.setAttribute("data-search",""),r.insertAdjacentHTML("beforeend",'<li tabindex="0">*</li>'),s.forEach((e=>{r.insertAdjacentHTML("beforeend",`<li tabindex="0" data-${t}="${e[t]}" ${e.selected?"selected":""}>${e.name}</li>`)})),r.addEventListener("click",(r=>{const n=r.target.closest("li");if(n.hasAttribute("selected")?n.removeAttribute("selected"):n.setAttribute("selected",""),"*"===n.innerHTML){const e=n.hasAttribute("selected");for(let n of r.currentTarget.children)"none"!==n.style.display&&(e?(s.find((e=>e[t]===n.dataset[t])).selected=!0,n.setAttribute("selected","")):(s.find((e=>e[t]===n.dataset[t])).selected=!1,n.removeAttribute("selected")))}else s.find((e=>e[t]===n.dataset[t])).selected=n.hasAttribute("selected"),r.currentTarget.firstChild.removeAttribute("selected");const a=[...r.currentTarget.children].sort(((e,t)=>(e.hasAttribute("selected")?"*":"")+e.innerText<(t.hasAttribute("selected")?"*":"")+t.innerText?-1:1));r.currentTarget.innerHTML="",a.forEach((e=>r.currentTarget.insertAdjacentElement("beforeend",e))),n.focus(),e.value=JSON.stringify(s)})),r.addEventListener("mousemove",(e=>{e.target.closest("li")?.focus()})),r.addEventListener("keydown",(e=>{let t=e.target.closest("li");switch(e.key){case"ArrowUp":if(t.previousElementSibling){for(t=t.previousElementSibling;"none"===t.style.display;t=t.previousElementSibling);t.focus()}break;case"ArrowDown":if(t.nextElementSibling){for(t=t.nextElementSibling;"none"===t?.style.display;t=t.nextElementSibling);t?.focus()}break;case"Enter":t.click();break;case"Tab":break;default:const s=e.currentTarget;"Backspace"===e.key||"Delete"===e.key?(s.dataset.search="",s.firstChild.removeAttribute("selected")):1===e.key.length&&(s.dataset.search+=e.key.toLowerCase());for(let e of s.children){let t=e.innerText.toLowerCase();"*"==t||e.hasAttribute("selected")||-1!=t.indexOf(s.dataset.search)?e.style.display="":e.style.display="none"}s.firstChild.focus()}})),e.insertAdjacentElement("afterend",r)}window.addEventListener("load",kvSelect);