class kvTags extends HTMLElement{static lists={};constructor(){super()}connectedCallback(){const e=this.getAttribute("list")||this.getAttribute("name")+"_list",t=this.getAttribute("options")||"";kvTags.lists[e]=kvTags.lists[e]||t;try{fetch(new URL(t)).then((e=>e.text())).then((t=>this.render(e,t.split(","))))}catch{this.render(e,t.split(","))}}render(e,t=[]){const n=document.createElement("span");n.classList.add("kv-tags");const a=document.createElement("input");a.type="hidden",n.appendChild(a);let i=document.createElement("input");i.setAttribute("list",e),i.setAttribute("autocomplete","off"),i.style.width="inherit",-1!==kvTags.lists[e].indexOf("@value")&&i.setAttribute("onkeyup","kvTags.fetchItems(event)"),i.setAttribute("onchange","kvTags.changeItem(event)"),n.insertAdjacentHTML("beforeend",'<span style="white-space:nowrap"> ✚ </span>'),n.lastElementChild.insertAdjacentElement("afterbegin",i);let l=document.createElement("ul");l.style.padding=0,l.style.display="inline",n.appendChild(l),l.setAttribute("ondblclick","kvTags.manageItem(event)"),l.setAttribute("onclick","kvTags.manageItem(event)"),l.setAttribute("onkeyup","kvTags.manageItem(event)"),l.setAttribute("onfocusin","kvTags.manageItem(event)");let s="";for(let e of t)s+=e?`<option value="${e}">${e}</option>`:"";if(!document.getElementById(e)){let t=document.createElement("datalist");t.id=e,t.innerHTML=s,i.appendChild(t)}this.insertAdjacentElement("afterend",n),this.remove(),a.removeAttribute("list"),a.removeAttribute("options");const r=new MutationObserver((e=>{const t=e[0].target;let n="";for(let e of(t.getAttribute("value")||"").split(","))n+=e?`<li tabindex="0">${e}</li>`:"";t.parentElement.querySelector("ul").innerHTML=n}));r.observe(a,{attributes:!0,attributeFilter:["value"]});for(let e of this.attributes)a.setAttribute(e.name,e.value)}static fetchItems(e){if(e.target.value){const t=e.target.getAttribute("list");if(!document.getElementById(t)){let n=document.createElement("datalist");n.id=t,e.target.parentElement.appendChild(n)}fetch(kvTags.lists[t].replace("@value",e.target.value)).then((e=>e.text())).then((e=>document.getElementById(t).innerHTML=e.split(",").reduce(((e,t)=>e+'<option value="'+t+'">'+t+"</option>"),"")))}}static changeItem(e){let t=e.target.value.replace(/([^àèéìùòça-z0-9-.]+)/gi,""),n=e.currentTarget.parentElement.previousElementSibling;if(t){let a=e.currentTarget.parentElement.nextElementSibling;-1==a.innerHTML.indexOf(`<li tabindex="0">${t}</li>`)&&(n.value+=(n.value?",":"")+t,a.innerHTML+=`<li tabindex="0">${t}</li>`),e.target.value="",-1!==kvTags.lists[e.target.list.id].indexOf("@value")&&(document.getElementById(e.target.list.id).innerHTML="")}n.dispatchEvent(new Event("input",{bubbles:!0})),e.target.focus({focusVisible:!0})}static manageItem(e){if("keyup"===e.type&&"LI"===e.target.tagName&&e.ctrlKey&&"Enter"===e.key||"click"===e.type&&"LI"===e.target.tagName&&e.ctrlKey||"dblclick"===e.type&&"LI"===e.target.tagName)e.target.closest("ul").insertAdjacentElement("afterBegin",e.target),e.target.focus();else if("click"===e.type&&"LI"===e.target.tagName&&e.offsetX<2*parseInt(getComputedStyle(e.target).fontSize)||"LI"===e.target.tagName&&["Backspace","Delete"].includes(e.key)){let t=e.currentTarget.parentElement.firstElementChild,n=e.target.innerText;t.value=t.value.replace(new RegExp(`(^${n},|,${n}(?=,)|,${n}$|^${n}$)`,"gi"),""),t.dispatchEvent(new Event("input",{bubbles:!0})),e.target.remove()}}}customElements.define("kv-tags",kvTags);