async function kvMultiSelect(e){if(!(e instanceof Element))return void document.querySelectorAll(".kvMultiSelect").forEach((e=>kvMultiSelect(e)));e.style.display="none";const t=e.dataset.key||"_id",r=JSON.parse(e.value).sort(((e,t)=>e.name<t.name?-1:1));r.sort(((e,t)=>(e.selected?"*":"")+e.name<(t.selected?"*":"")+t.name?-1:1));const n=document.createElement("ol");n.className="kvMultiSelect",n.setAttribute("start",0),n.setAttribute("data-search",""),n.insertAdjacentHTML("beforeend",'<li tabindex="0">*</li>'),r.forEach((e=>{n.insertAdjacentHTML("beforeend",`<li tabindex="0" data-${t}="${e[t]}" ${e.selected?"selected":""}>${e.name}</li>`)})),n.addEventListener("click",(e=>{const t=e.target.closest("li");if(t.hasAttribute("selected")?t.removeAttribute("selected"):t.setAttribute("selected",""),"*"===t.innerHTML){const r=t.hasAttribute("selected");for(let t of e.currentTarget.children)"none"!==t.style.display&&(r?t.setAttribute("selected",""):t.removeAttribute("selected"))}else e.currentTarget.firstChild.removeAttribute("selected");const r=[...e.currentTarget.children].sort(((e,t)=>(e.hasAttribute("selected")?"*":"")+e.innerText<(t.hasAttribute("selected")?"*":"")+t.innerText?-1:1));e.currentTarget.innerHTML="",r.forEach((t=>e.currentTarget.insertAdjacentElement("beforeend",t))),t.focus()})),n.addEventListener("mousemove",(e=>{e.target.closest("li")?.focus()})),n.addEventListener("keydown",(e=>{let t=e.target.closest("li");switch(e.key){case"ArrowUp":if(t.previousElementSibling){for(t=t.previousElementSibling;"none"===t.style.display;t=t.previousElementSibling);t.focus()}break;case"ArrowDown":if(t.nextElementSibling){for(t=t.nextElementSibling;"none"===t?.style.display;t=t.nextElementSibling);t?.focus()}break;case"Enter":t.click();break;case"Tab":break;default:const r=e.currentTarget;"Backspace"===e.key||"Delete"===e.key?(r.dataset.search="",r.firstChild.removeAttribute("selected")):1===e.key.length&&(r.dataset.search+=e.key.toLowerCase());for(let e of r.children){let t=e.innerText.toLowerCase();"*"==t||e.hasAttribute("selected")||-1!=t.indexOf(r.dataset.search)?e.style.display="":e.style.display="none"}r.firstChild.focus()}})),e.insertAdjacentElement("afterend",n)}window.addEventListener("load",kvMultiSelect);