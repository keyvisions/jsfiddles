class stwTags extends HTMLElement{static lists={};constructor(){super()}connectedCallback(){const t=this.getAttribute("list")||this.getAttribute("name")+"_list",e=this.getAttribute("options")||"";stwTags.lists[t]=stwTags.lists[t]||e;try{fetch(new URL(e)).then((t=>t.text())).then((e=>this.render(t,e.split(","))))}catch{this.render(t,e.split(","))}}render(t,e=[]){const n=document.createElement("span");n.classList.add("stwTags");const a=document.createElement("input");a.type="hidden",n.appendChild(a);let i=document.createElement("input");i.setAttribute("list",t),i.setAttribute("autocomplete","off"),i.style.width="inherit",-1!==stwTags.lists[t].indexOf("@value")&&i.setAttribute("onkeyup","stwTags.fetchItems(event)"),i.setAttribute("onchange","stwTags.changeItem(event)"),n.insertAdjacentHTML("beforeend",'<span style="white-space:nowrap"> ✚ </span>'),n.lastElementChild.insertAdjacentElement("afterbegin",i);let s=document.createElement("ul");s.style.padding=0,s.style.display="inline",n.appendChild(s),s.setAttribute("onclick","stwTags.manageItem(event)"),s.setAttribute("onkeyup","stwTags.manageItem(event)"),s.setAttribute("onfocusin","stwTags.manageItem(event)");let l="";for(let t of e)l+=t?`<option value="${t}">${t}</option>`:"";if(!document.getElementById(t)){let e=document.createElement("datalist");e.id=t,e.innerHTML=l,i.appendChild(e)}this.insertAdjacentElement("afterend",n),this.remove(),a.removeAttribute("list"),a.removeAttribute("options");const r=new MutationObserver((t=>{const e=t[0].target;let n="";for(let t of(e.getAttribute("value")||"").split(","))n+=t?`<li tabindex="0">${t}</li>`:"";e.parentElement.querySelector("ul").innerHTML=n}));r.observe(a,{attributes:!0,attributeFilter:["value"]});for(let t of this.attributes)a.setAttribute(t.name,t.value)}static fetchItems(t){if(t.target.value){const e=t.target.getAttribute("list");if(!document.getElementById(e)){let n=document.createElement("datalist");n.id=e,t.target.parentElement.appendChild(n)}fetch(stwTags.lists[e].replace("@value",t.target.value)).then((t=>t.text())).then((t=>document.getElementById(e).innerHTML=t.split(",").reduce(((t,e)=>t+'<option value="'+e+'">'+e+"</option>"),"")))}}static changeItem(t){let e=t.target.value.replace(/([^àèéìùòça-z0-9-.]+)/gi,""),n=t.currentTarget.parentElement.previousElementSibling;if(e){let a=t.currentTarget.parentElement.nextElementSibling;-1==a.innerHTML.indexOf(`<li tabindex="0">${e}</li>`)&&(n.value+=(n.value?",":"")+e,a.innerHTML+=`<li tabindex="0">${e}</li>`),t.target.value="",-1!==stwTags.lists[t.target.list.id].indexOf("@value")&&(document.getElementById(t.target.list.id).innerHTML="")}n.dispatchEvent(new Event("input",{bubbles:!0})),t.target.focus({focusVisible:!0})}static manageItem(t){if("keyup"===t.type&&"LI"===t.target.tagName&&t.ctrlKey&&"Enter"===t.key||"click"===t.type&&"LI"===t.target.tagName&&t.ctrlKey)t.target.closest("ul").insertAdjacentElement("afterBegin",t.target),t.target.focus();else if("click"===t.type&&"LI"===t.target.tagName&&t.offsetX<2*parseInt(getComputedStyle(t.target).fontSize)||"LI"===t.target.tagName&&["Backspace","Delete"].includes(t.key)){let e=t.currentTarget.parentElement.firstElementChild,n=t.target.innerText;e.value=e.value.replace(new RegExp(`(^${n},|,${n}(?=,)|,${n}$|^${n}$)`,"gi"),""),e.dispatchEvent(new Event("input",{bubbles:!0})),t.target.remove()}}}customElements.define("stw-tags",stwTags);