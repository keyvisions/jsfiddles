class stwTags extends HTMLElement{static lists={};constructor(){super()}connectedCallback(){const e=this.getAttribute("list")||this.getAttribute("name")+"_list",t=this.getAttribute("options")||"";stwTags.lists[e]=stwTags.lists[e]||t;try{fetch(new URL(t)).then((e=>e.text())).then((t=>this.render(e,t.split(","))))}catch{this.render(e,t.split(","))}}render(e,t=[]){const n=document.createElement("span");n.classList.add("stwTags");const s=document.createElement("input");s.type="hidden",n.appendChild(s);let i=document.createElement("input");i.setAttribute("list",e),i.setAttribute("autocomplete","off"),i.style.width="inherit",-1!==stwTags.lists[e].indexOf("@value")&&i.setAttribute("onkeyup","stwTags.fetchItems(event)"),i.setAttribute("onchange","stwTags.changeItem(event)"),n.insertAdjacentHTML("beforeend",'<span style="white-space:nowrap"> ✚ </span>'),n.lastElementChild.insertAdjacentElement("afterbegin",i);let a=document.createElement("ul");a.style.padding=0,a.style.display="inline",n.appendChild(a),a.setAttribute("onclick","stwTags.manageItem(event)"),a.setAttribute("onkeyup","stwTags.manageItem(event)"),a.setAttribute("onfocusin","stwTags.manageItem(event)");let l="";for(let e of t)l+=e?`<option value="${e}">${e}</option>`:"";if(!document.getElementById(e)){let t=document.createElement("datalist");t.id=e,t.innerHTML=l,n.appendChild(t)}this.insertAdjacentElement("afterend",n),this.remove(),s.removeAttribute("list"),s.removeAttribute("options");const r=new MutationObserver((e=>{const t=e[0].target;let n="";for(let e of(t.getAttribute("value")||"").split(","))n+=e?`<li tabindex="0">${e}</li>`:"";t.parentElement.querySelector("ul").innerHTML=n}));r.observe(s,{attributes:!0,attributeFilter:["value"]});for(let e of this.attributes)s.setAttribute(e.name,e.value)}static fetchItems(e){e.target.value&&fetch(stwTags.lists[e.target.list.id].replace("@value",e.target.value)).then((e=>e.text())).then((t=>document.getElementById(e.target.list.id).innerHTML=t.split(",").reduce(((e,t)=>e+'<option value="'+t+'">'+t+"</option>"),"")))}static changeItem(e){let t=e.target.value.replace(/([^àèéìùòça-z0-9-.]+)/gi,""),n=e.currentTarget.parentElement.previousElementSibling;if(t){let s=e.currentTarget.parentElement.nextElementSibling;-1==s.innerHTML.indexOf(`<li tabindex="0">${t}</li>`)&&(n.value+=(n.value?",":"")+t,s.innerHTML+=`<li tabindex="0">${t}</li>`),e.target.value="",-1!==stwTags.lists[e.target.list.id].indexOf("@value")&&(document.getElementById(e.target.list.id).innerHTML="")}n.dispatchEvent(new Event("input",{bubbles:!0})),e.target.focus({focusVisible:!0})}static manageItem(e){if("focusin"!==e.type||e.ctrlKey)if("click"===e.type&&"LI"===e.target.tagName&&(e.offsetX<2*parseInt(getComputedStyle(e.target).fontSize)||["Backspace","Delete"].includes(e.key))){let t=e.currentTarget.parentElement.firstElementChild,n=e.target.innerText;t.value=t.value.replace(new RegExp(`(^${n},|,${n}(?=,)|,${n}$|^${n}$)`,"gi"),""),t.dispatchEvent(new Event("input",{bubbles:!0})),e.target.remove()}else"keyup"===e.type&&"Tab"!==e.key&&e.currentTarget.closest("span").querySelector("input[list]").focus({focusVisible:!0});else e.target.dispatchEvent(new KeyboardEvent("keyup",{bubbles:!0,key:"Tab"}))}}customElements.define("stw-tags",stwTags);