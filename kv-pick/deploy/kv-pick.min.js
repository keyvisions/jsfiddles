class kvPick extends HTMLElement{batchCode="";constructor(){super(),fetch(this.getAttribute("src")).then((t=>t.json())).then((t=>this.render(t))).catch((()=>this.render(JSON.parse(this.innerText||'{"requested":null,"picked":null,"Batches":[]}'))))}render(t){this.batchCode=this.getAttribute("batch"),this.innerHTML=`<input id="batches" type="hidden" name="${this.getAttribute("data-batches")}">\n\t\t\t<table>\n\t\t\t\t<thead>\n\t\t\t\t\t<tr><th>Data<br>scadenza</th><th>Lotto</th><th>Ubicazione</th><th>Quantità</th><th>Quantità<br>prelevata</th></tr>\n\t\t\t\t\t<tr style="font-weight:bolder; text-align:right"><td colspan="2"></td><td>Totale</td><td class="requested">${t.requested}</td><td><input id="picked" type="number" name="${this.getAttribute("data-quantity")}" readonly title="Prelievo"></td></tr>\n\t\t\t\t</thead>\n\t\t\t\t<tbody>\n\t\t\t\t${t.batches?.map((e=>`<tr id="${(e.name||"BULK_"+t.code).toUpperCase()}"><td>${e.expiration||""}</td><td>${(e.name.startsWith("BULK_")?"BULK":e.name).toUpperCase()}</td><td>${e.location||""}</td><td class="available" style="text-align:right">${e.available||""}</td><td style="text-align:right"><input form="none" type="number" name="picked" title="Prelievo" min="0" value="${e.picked||""}"></td></tr>`)).join("")}\n\t\t\t\t</tbody>\n\t\t\t</table>`,this.removeAttribute("name"),this.hasAttribute("tabindex")||this.setAttribute("tabindex",0),this.addEventListener("change",(()=>{const t=parseFloat(this.querySelector("td.requested").innerText),e=this.querySelector("#picked");let i=0;this.querySelectorAll("input[name=picked]").forEach((t=>i+=isNaN(parseFloat(t.value))?0:parseFloat(t.value))),e.value=i,e.className=i==t?"":"invalid";const a={};this.querySelectorAll("tbody>tr").forEach((t=>{t.querySelector("[name=picked]").value>0&&(a[t.id]=parseFloat(t.querySelector("[name=picked]").value))})),this.querySelector("#batches").value=JSON.stringify(a)})),this.addEventListener("keyup",(t=>{if(t.target==this)if("Enter"==t.key){if(this.querySelector(".selected")?.classList.remove("selected"),this.querySelector(`tr[id="${this.batchCode.toUpperCase()}"]`)?.classList.add("selected"),this.querySelector(".selected")){this.querySelector(".selected").scrollIntoView(!1);const t=parseFloat(this.querySelector("td.requested").innerText),e=parseFloat(this.querySelector(".selected td.available").innerText),i=parseFloat(this.querySelector("#picked").value)||0;let a=i<t?t-i:null;a=a>e?e:a,this.querySelector(".selected input").setAttribute("value",a),this.dispatchEvent(new Event("change"))}this.batchCode=""}else 1==t.key.length&&(this.batchCode+=t.key)})),this.dispatchEvent(new Event("change")),this.dispatchEvent(new KeyboardEvent("keyup",{key:"Enter"}))}}customElements.define("kv-pick",kvPick);