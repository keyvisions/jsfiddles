function kvJSONForm(e,t){if(!(e instanceof Element))return void document.querySelectorAll("[data-json]").forEach(((e,t)=>{document.querySelector(`form[id="json${t}"]`)||document.body.insertAdjacentHTML("beforeend",`<form id="json${t}"></form>`),kvJSONForm(e,t)}));let r,o=e.form;if(o){o.addEventListener("submit",(e=>{let t=o.querySelector(":not(.dataRow) [form^=json]:invalid");if(!t)return!0;e.preventDefault(),t.form.reportValidity()})),o.classList.add("kvJSONForm"),o.jsonField=e,o.querySelectorAll("[form=json]").forEach((e=>{e.setAttribute("form",`json${t}`),e.classList.add("JSONData")})),o.hasAttribute("disabled")&&(o.querySelectorAll('button, input[type="button"], input[type="submit"], input[type="reset"]').forEach((e=>{e.style.display="none"})),o.querySelectorAll(".JSONData").forEach((e=>{if("DIV"==e.tagName)e.removeAttribute("contenteditable");else{if("TABLE"==e.tagName)return;e.disabled=!0,"disabled"==e.value&&(e.value="")}}))),o.newColumn=e=>{if(e.querySelector("tbody")||e.querySelector("tbody.dataRow").insertAdjacentHTML("beforebegin","<tbody></tbody>"),e.querySelector("tbody").childElementCount){let t=e.querySelector("thead>tr>th:nth-child(2)").cloneNode(!0);e.querySelector("thead>tr>th").insertAdjacentElement("afterend",t);let r=e.querySelectorAll("tbody.dataRow td");for(let t=0;t<r.length;++t)e.querySelector("tbody").children[t].appendChild(r[t].cloneNode(!0))}else e.querySelector("tbody").insertAdjacentHTML("afterbegin",e.querySelector("tbody.dataRow").innerHTML)},o.JSONStringify=function(e,t){if(e.target&&!e.target.classList.contains("JSONData")&&!e.target.closest(".deleteRow"))return;let r=e.currentTarget,o=JSON.parse(r.jsonField.value||"{}"),a=t||e.target;if(t=a.closest("table")&&a.closest("table").classList.contains("JSONData")?a.closest("table"):t){let e=t.getAttribute("name");if(o[e]=[],t.classList.contains("columnar")){for(let r=0;r<t.querySelectorAll("tbody:not(.dataRow)>tr:first-child .JSONData[name]").length;++r)o[e].push({});t.querySelectorAll("tbody:not(.dataRow)>tr").forEach((function(t,a){t.querySelectorAll(".JSONData[name]").forEach((function(t,a){o[e][a][t.getAttribute("name")]=r.valueStringify(t)}))}))}else t.querySelectorAll("tbody:not(.dataRow)").forEach((t=>{let a={};t.querySelectorAll(".JSONData[name]").forEach((e=>{a[e.getAttribute("name")]=r.valueStringify(e)})),o[e].push(a)})),o[`${e}_summary`]={},t.querySelectorAll("tfoot output[for]").forEach((r=>{let a=0;t.querySelectorAll(`tbody input[name=${r.getAttribute("for")}]`).forEach((e=>a+=parseFloat(e.value)||0)),r.value=a,o[`${e}_summary`][r.getAttribute("for")]=a}));t.querySelector("tbody.dataRow").onchange&&t.querySelector("tbody.dataRow").onchange(t)}else o[a.getAttribute("name")]=r.valueStringify(a);r.jsonField.value=JSON.stringify(o)},o.valueStringify=e=>{let t;return"checkbox"!=e.type||null!=e.value&&"on"!=e.value?"checkbox"==e.type?(t=[],e.closest("fieldset").querySelectorAll("[type=checkbox]").forEach((e=>{e.checked&&t.push(e.value)}))):"select-multiple"==e.type?(t=[],e.querySelectorAll("option").forEach((e=>{e.selected&&t.push(e.value)}))):t=void 0!==e.value?e.value:e.innerHTML:(t=0,e.closest("fieldset")?e.closest("fieldset").querySelectorAll("[type=checkbox]").forEach(((e,r)=>{t=(t||0)|e.checked<<r})):t=e.checked),e.classList.add("modified"),t},o.JSONParse=e=>{let t,r=e.target.closest("form");try{t=JSON.parse(r.jsonField.value||"{}"),r.style.backgroundColor="inherit",r.title=""}catch(e){return r.style.backgroundColor="rgba(255,0,0,0.1)",void(r.title=e)}Object.keys(t).forEach((e=>{let o=r.querySelector('.JSONData[name="'+e+'"]');if(o&&"TABLE"==o.tagName&&o.classList.contains("JSONData"))if(o.querySelector("tfoot")||o.insertAdjacentHTML("beforeend","<tfoot></tfoot>"),o.hasAttribute("data-key")||o.querySelectorAll("tbody:not(.dataRow)").forEach((e=>{e.remove()})),o.classList.contains("columnar")){o.querySelector("tbody.dataRow").insertAdjacentHTML("beforebegin","<tbody></tbody>");let a=o.querySelectorAll(".deleteColumn");for(let e=a.length-1;e>0;--e)a[e].parentElement.removeChild(a[e]);for(let a=0;a<t[e].length;++a)r.newColumn(o);t[e].forEach((function(e,t){Object.keys(e).forEach((a=>{let l=o.querySelector(`tbody:not(.dataRow) td:nth-child(${t+2}) .JSONData[name="${a}"]`);l&&r.parseValue(l,e[a])}))}))}else o.hasAttribute("data-key")?o.querySelectorAll("tbody[data-key]").forEach(((l,n)=>{let c=t[e].find((e=>e[o.getAttribute("data-key")]==l.getAttribute("data-key")))||{[o.getAttribute("data-key")]:l.getAttribute("data-key")},i=document.createElement("tbody");o.classList.contains("sortable")&&a(l),i.innerHTML=o.querySelector("tbody.dataRow").innerHTML,i.querySelectorAll("td").forEach(((e,t)=>{""!=e.innerHTML&&(l.querySelector(`td:nth-child(${t+1})`).innerHTML=(0==t?`${n+1}.`:"")+e.innerHTML)})),Object.keys(c).forEach((e=>{let t=l.querySelector(`.JSONData[name="${e}"]`);t&&r.parseValue(t,c[e])}))})):t[e].forEach((e=>{let t=document.createElement("tbody");o.classList.contains("sortable")&&a(t),t.innerHTML=o.querySelector("tbody.dataRow").innerHTML,Object.keys(e).forEach((o=>{let a=t.querySelector(`.JSONData[name="${o}"]`);a&&r.parseValue(a,e[o])}));let l=t.querySelector('input[name=""]');l&&(l.name="name",l.value=Object.keys(e).name||"U"+Math.floor(1e13*performance.now())),o.querySelector("tfoot").insertAdjacentElement("beforebegin",t)})),o.querySelectorAll("tfoot output[for]").forEach((e=>{let t=0;o.querySelectorAll(`tbody input[name=${e.getAttribute("for")}]`).forEach((e=>t+=parseFloat(e.value)||0)),e.value=t}));else r.parseValue(o,t[e])})),r.querySelectorAll("table.JSONData").forEach((e=>{e.querySelector("tbody.dataRow").onchange&&e.querySelector("tbody.dataRow").onchange(e)}));for(let e=0;e<r.childElementCount;++e){let o=r[e];o&&o.value&&void 0===t[o.getAttribute("name")]&&o.classList.contains("JSONData")&&r.JSONStringify({currentTarget:r,target:o})}},o.parseValue=function(e,t){!e||"TD"==e.tagName||"DIV"==e.tagName&&"true"==!e.contentEditable||("DIV"==e.tagName?e.innerHTML=t:"checkbox"==e.type||"radio"==e.type?e.closest("fieldset")?Array.isArray(t)?e.closest("fieldset").querySelectorAll("[type=checkbox]").forEach((e=>{e.checked=!!t.find((t=>t==e.value))})):"radio"==e.type?e.closest("fieldset").querySelectorAll("[type=radio]").forEach((e=>{e.checked=t==e.value})):e.closest("fieldset").querySelectorAll("[type=checkbox]").forEach((function(e,r){e.checked=!!((t||0)&1<<r)})):e.checked=!!t:"select-multiple"==e.type?e.querySelectorAll("option").forEach((e=>{t.find((t=>t==e.value))&&e.setAttribute("selected","")})):e.value=t)};try{JSON.parse(e.value),e.value||(e.value="{}")}catch(t){e.value="{}"}o.JSONParse({target:e}),o.zoom=function(e,t){t=t||e.target,"mousedown"!=e.type&&"F2"!=e.key||"TEXTAREA"!=t.tagName&&!t.hasAttribute("contenteditable")||(t.closest("label")?t.closest("label").classList.toggle("zoom"):t.classList.toggle("zoom"),t.blur(),t.focus(),e.stopPropagation(),e.preventDefault())},o.addEventListener("keydown",o.zoom),o.addEventListener("input",o.JSONStringify),o.addEventListener("click",(e=>{if(e.target.hasAttribute("contenteditable"))return void e.preventDefault();let t=e.target.closest("th")||e.target.closest("td");if(!t)return;let r=e.target.closest("table");if(t=t.classList,t.contains("newRow")){let t=r.querySelector('tbody.dataRow input[name=""]');t&&(t.name="name",t.value="U"+Math.floor(1e13*performance.now()));let o=r.querySelector("tbody.dataRow").cloneNode(!0);o.classList.remove("dataRow"),r.querySelector("tfoot").insertAdjacentElement("beforeBegin",o),r.classList.contains("sortable")&&a(r.querySelector("tfoot").previousElementSibling),e.stopPropagation()}else if(t.contains("deleteRow")&&confirm("Sicuri di voler eliminare la riga?"))e.target.closest("tbody").remove(),r.querySelector("tbody.dataRow").onchange&&r.querySelector("tbody.dataRow").onchange(r),o.JSONStringify(e,r),e.stopPropagation();else if(t.contains("newColumn"))o.newColumn(r),e.stopPropagation();else if(t.contains("deleteColumn")&&confirm("Sicuri di voler eliminare la colonna?")){let t=r.querySelectorAll("thead>tr, tbody>tr"),a=e.target.closest("th").cellIndex;if(2==t[0].childElementCount)r.querySelector("tbody").innerHTML="";else for(let e=0;e<t.length;++e)t[e].removeChild(t[e].children[a]);let l=JSON.parse(o.jsonField.value||"{}");l[r.getAttribute("name")]&&(l[r.getAttribute("name")].splice(a-1,1),o.jsonField.value=JSON.stringify(l)),o.JSONStringify(e),e.stopPropagation()}})),o.formatText=e=>{let t=window.getSelection();if(e.target.dataset.format&&t&&t.rangeCount){let r=t.getRangeAt(0),o=document.createElement(e.target.dataset.format);o.innerHTML=r,o.setAttribute("title",Date().toLocaleString()),r.deleteContents(),r.insertNode(o)}else if("expand"==e.target.dataset.action&&document.activeElement.hasAttribute("contenteditable"))return void o.zoom(e,document.activeElement);e.preventDefault(),e.stopPropagation()}}function a(e){e.setAttribute("draggable",!0),e.addEventListener("dragstart",(e=>{r=e.target,r.style.backgroundColor="#EEE",e.dataTransfer.setDragImage(document.createElement("div"),0,0)})),e.addEventListener("dragover",(e=>{e.preventDefault(),e.dataTransfer.dropEffect="move",e.currentTarget==r.previousElementSibling||"THEAD"==e.currentTarget.previousElementSibling.tagName?e.currentTarget.insertAdjacentElement("beforeBegin",r):e.currentTarget.insertAdjacentElement("afterEnd",r)})),e.addEventListener("drop",(()=>{r.style.backgroundColor=null,o.JSONStringify({currentTarget:o},e.closest("table"))}))}}