function kvJSONForm(jsonField,ith){if(!(jsonField instanceof Element))return void document.querySelectorAll("[data-json]").forEach(((e,t)=>{document.querySelector(`form[id="json${t}"]`)||document.body.insertAdjacentHTML("beforeend",`<form id="json${t}" style="display:none"></form>`),kvJSONForm(e,t)}));const form=jsonField.form;if(!form)return;let dragged_tbody;function sortableBody(e){e.setAttribute("draggable",!0),e.addEventListener("dragstart",(e=>{if(!document.elementFromPoint(e.clientX,e.clientY).classList.contains("fa-grip-vertical"))return e.stopPropagation(),void e.preventDefault();dragged_tbody=e.target,dragged_tbody.style.backgroundColor="#EEE",e.dataTransfer.setDragImage(document.createElement("div"),0,0)})),e.addEventListener("dragover",(e=>{if(e.preventDefault(),dragged_tbody.closest("table").getAttribute("name")!=e.target.closest("table").getAttribute("name"))return e.dataTransfer.dropEffect="none",void e.stopPropagation();e.dataTransfer.dropEffect="move",e.currentTarget==dragged_tbody.previousElementSibling||"THEAD"==e.currentTarget.previousElementSibling.tagName?e.currentTarget.insertAdjacentElement("beforeBegin",dragged_tbody):e.currentTarget.insertAdjacentElement("afterEnd",dragged_tbody)})),e.addEventListener("drop",(t=>{dragged_tbody.style.backgroundColor=null,form.JSONStringify({currentTarget:form},e.closest("table"))}))}form.addEventListener("submit",(e=>{let t=form.querySelector("[form^=json]:invalid");if(!t)return!0;e.preventDefault(),t.form.reportValidity()})),form.classList.add(jsonField.hasAttribute("data-cssclass")&&jsonField.dataset.cssclass||"kvJSONForm"),form.jsonField=jsonField,form.querySelectorAll("[form=json]").forEach((e=>{e.setAttribute("form",`json${ith}`),e.classList.add("JSONData")})),form.executeFunctionByName=function(e,t){for(var a=Array.prototype.slice.call(arguments,2),r=e.split("."),o=r.pop(),l=0;l<r.length;l++)t=t[r[l]]||window;return t[o]?.apply(t,a)},form.hasAttribute("disabled")&&(form.querySelectorAll('button, input[type="button"], input[type="submit"], input[type="reset"]').forEach((e=>{e.style.display="none"})),form.querySelectorAll(".JSONData").forEach((e=>{if("DIV"==e.tagName)e.removeAttribute("contenteditable");else{if("TABLE"==e.tagName)return;e.disabled=!0,"disabled"==e.value&&(e.value="")}}))),form.newColumn=e=>{if(e.querySelector("tbody")||e.querySelector(".dataRow").insertAdjacentHTML("beforebegin","<tbody></tbody>"),e.querySelector("tbody").childElementCount){let t=e.querySelector("thead>tr>th:nth-child(2)").cloneNode(!0);e.querySelector("thead>tr>th").insertAdjacentElement("afterend",t);let a=e.querySelectorAll(".dataRow td");for(let t=0;t<a.length;++t)e.querySelector("tbody").children[t].appendChild(a[t].cloneNode(!0))}else e.querySelector("tbody").insertAdjacentHTML("afterbegin",e.querySelector(".dataRow").innerHTML)},form.JSONStringify=function(e,t){if(e.target&&!e.target.classList.contains("JSONData")&&!e.target.closest(".deleteRow"))return;let a=e.currentTarget,r=JSON.parse(a.jsonField.value||"{}"),o=t||e.target;if(t=o.closest("table")&&o.closest("table").classList.contains("JSONData")?o.closest("table"):t){let e=t.getAttribute("name");if(r[e]=[],t.classList.contains("columnar")){for(let a=0;a<t.querySelectorAll("tbody>tr:first-child .JSONData[name]").length;++a)r[e].push({});t.querySelectorAll("tbody>tr").forEach((function(t,o){t.querySelectorAll(".JSONData[name]").forEach((function(t,o){r[e][o][t.getAttribute("name")]=a.valueStringify(t)}))}))}else t.querySelectorAll("tbody").forEach((t=>{let o={};t.querySelectorAll(".JSONData[name]").forEach((e=>{o[e.getAttribute("name")]=a.valueStringify(e)})),r[e].push(o)})),r[`${e}_summary`]={},t.querySelectorAll("tfoot output[for]").forEach((a=>{let o=0,l=0;switch(t.querySelectorAll(`tbody input[name=${a.getAttribute("for")}]`).forEach((e=>{l+=e.value?1:0,-1==e.value.indexOf(":")?o+=parseFloat(e.value)||0:o+=e.value.split(":").reduce((function(e,t){return+t+60*e}),0)/60})),a.dataset.action){case"count":a.value=l;break;case"sum":a.value=a.hasAttribute("step")?o.toFixed(-Math.log10(a.getAttribute("step"))):o;break;case"avg":a.value=a.hasAttribute("step")?(o/l).toFixed(-Math.log10(a.getAttribute("step"))):o/l}isNaN(a.value)&&(a.value=""),r[`${e}_summary`][a.getAttribute("for")]=a.value}));t.querySelector(".dataRow").onchange&&t.querySelector(".dataRow").onchange(t)}else r[o.getAttribute("name")]=a.valueStringify(o);a.jsonField.value=JSON.stringify(r),a.jsonField.dispatchEvent(new Event("input"))},form.valueStringify=e=>{let t;return"checkbox"!=e.type||null!=e.value&&"on"!=e.value?"checkbox"==e.type?(t=[],e.closest("fieldset").querySelectorAll("[type=checkbox]").forEach((e=>{e.checked&&t.push(e.value)}))):"select-multiple"==e.type?(t=[],e.querySelectorAll("option").forEach((e=>{e.selected&&t.push(e.value)}))):t=void 0!==e.value?e.value:e.innerHTML:(t=0,e.closest("fieldset")?e.closest("fieldset").querySelectorAll("[type=checkbox]").forEach(((e,a)=>{t=(t||0)|e.checked<<a})):t=e.checked),e.classList.add("modified"),t},form.JSONParse=event=>{let form=event.target.closest("form"),data;try{data=JSON.parse(form.jsonField.value||"{}"),form.style.backgroundColor="inherit",form.title=""}catch(e){return form.style.backgroundColor="rgba(255,0,0,0.1)",void(form.title=e)}Object.keys(data).forEach((datum=>{let el=form.querySelector('.JSONData[name="'+datum+'"]');if(el&&"TABLE"==el.tagName&&el.classList.contains("JSONData")){if(el.querySelector("tfoot")||el.insertAdjacentHTML("beforeend","<tfoot></tfoot>"),el.hasAttribute("data-key")||el.querySelectorAll("tbody").forEach((e=>{e.remove()})),el.classList.contains("columnar")){el.querySelector(".dataRow").insertAdjacentHTML("beforebegin","<tbody></tbody>");let e=el.querySelectorAll(".deleteColumn");for(let t=e.length-1;t>0;--t)e[t].parentElement.removeChild(e[t]);for(let e=0;e<data[datum].length;++e)form.newColumn(el);data[datum].forEach((function(e,t){Object.keys(e).forEach((a=>{let r=el.querySelector(`tbody td:nth-child(${t+2}) .JSONData[name="${a}"]`);r&&form.parseValue(r,e[a])}))}))}else el.hasAttribute("data-key")?el.querySelectorAll("tbody[data-key]").forEach(((e,t)=>{let a=data[datum].find((t=>t[el.getAttribute("data-key")]==e.getAttribute("data-key")))||{[el.getAttribute("data-key")]:e.getAttribute("data-key")},r=document.createElement("tbody");r.innerHTML=el.querySelector(".dataRow").innerHTML,el.classList.contains("sortable")&&sortableBody(e),r.querySelectorAll("[form=json]").forEach((e=>{e.setAttribute("form",`json${ith}`),e.classList.add("JSONData")}));const o=e.querySelectorAll("td");r.querySelectorAll("td").forEach(((e,a)=>{""!=e.innerHTML&&(o[a].innerHTML=(0==a?`${t+1}.`:"")+e.innerHTML)})),Object.keys(a).forEach((t=>{let r=e.querySelector(`.JSONData[name="${t}"]`);r&&form.parseValue(r,a[t])})),e.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!1}))})):data[datum].forEach((e=>{let t=document.createElement("tbody");t.innerHTML=el.querySelector(".dataRow").innerHTML,el.classList.contains("sortable")&&sortableBody(t),t.querySelectorAll("[form=json]").forEach((e=>{e.setAttribute("form",`json${ith}`),e.classList.add("JSONData")})),Object.keys(e).forEach((a=>{"name"==a&&t.querySelector('input[name=""]')&&t.querySelector('input[name=""]').setAttribute("name",a);let r=t.querySelector(`.JSONData[name="${a}"]`);r&&form.parseValue(r,e[a])}));let a=t.querySelector('input[name=""]');a&&(a.name="name",a.value=Object.keys(e).name||"U"+Math.floor(1e13*performance.now())),el.querySelector("tfoot").insertAdjacentElement("beforebegin",t),t.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!1}))})),el.querySelectorAll("tfoot output[for]").forEach((e=>{let t=0,a=0;switch(el.querySelectorAll(`tbody input[name=${e.getAttribute("for")}]`).forEach((e=>{t+=e.value?1:0,a+=parseFloat(e.value)||0})),e.dataset.action){case"count":e.value=t;break;case"sum":e.value=a;break;case"avg":e.value=a/t}}));el.querySelector(".dataRow")?.hasAttribute("onload")&&eval(el.querySelector(".dataRow").getAttribute("onload"))}else form.parseValue(el,data[datum])})),form.querySelectorAll("table.JSONData").forEach((e=>{e.querySelector(".dataRow").onchange&&e.querySelector(".dataRow").onchange(e)})),form.querySelectorAll('[form*="json"]').forEach((e=>{form.JSONStringify({currentTarget:form,target:e})}))},form.parseValue=function(e,t){!e||"TD"==e.tagName||"DIV"==e.tagName&&"true"==!e.contentEditable||("DIV"==e.tagName?e.innerHTML=t:"checkbox"==e.type||"radio"==e.type?e.closest("fieldset")?Array.isArray(t)?e.closest("fieldset").querySelectorAll("[type=checkbox]").forEach((e=>{e.checked=!!t.find((t=>t==e.value))})):"radio"==e.type?e.closest("fieldset").querySelectorAll("[type=radio]").forEach((e=>{e.checked=t==e.value})):e.closest("fieldset").querySelectorAll("[type=checkbox]").forEach((function(e,a){e.checked=!!((t||0)&1<<a)})):e.checked=!!t:"select-multiple"==e.type?e.querySelectorAll("option").forEach((e=>{t.find((t=>t==e.value))&&e.setAttribute("selected","")})):(e.setAttribute("value",t),e.value=t))};try{JSON.parse(jsonField.value),jsonField.value||(jsonField.value="{}")}catch(e){jsonField.value="{}"}form.JSONParse({target:jsonField}),form.zoom=function(e,t){t=t||e.target,"mousedown"!=e.type&&"F2"!=e.key||"TEXTAREA"!=t.tagName&&!t.hasAttribute("contenteditable")||(t.closest("label")?t.closest("label").classList.toggle("zoom"):t.classList.toggle("zoom"),t.blur(),t.focus(),e.stopPropagation(),e.preventDefault())},form.addEventListener("keydown",form.zoom),form.addEventListener("input",form.JSONStringify),form.addEventListener("click",(event=>{if(event.target.hasAttribute("contenteditable"))return void event.preventDefault();let action=event.target.closest("th")||event.target.closest("td");if(!action)return;let table=event.target.closest("table");if(action=action.classList,action.contains("newRow")){let fld=table.querySelector('.dataRow input[name=""]');fld&&(fld.name="name",fld.value="U"+Math.floor(1e13*performance.now()));let newRow=document.createElement("tbody");newRow.innerHTML=table.querySelector(".dataRow").innerHTML,newRow.querySelectorAll("[form=json]").forEach((e=>{e.setAttribute("form",table.getAttribute("form")),e.classList.add("JSONData")})),table.querySelector("tfoot").insertAdjacentElement("beforeBegin",newRow),table.classList.contains("sortable")&&sortableBody(table.querySelector("tfoot").previousElementSibling),event.stopPropagation(),table.querySelector(".dataRow").hasAttribute("onload")&&eval(table.querySelector(".dataRow").getAttribute("onload"))}else if(action.contains("deleteRow")&&(event.ctrlKey||confirm("it"===(window.navigator.userLanguage||window.navigator.language)?"Sicuri di voler eliminare la riga?":"Are you sure you want to delete the row?")))event.target.closest("tbody").remove(),table.querySelector(".dataRow").onchange&&table.querySelector(".dataRow").onchange(table),form.JSONStringify(event,table),event.stopPropagation();else if(action.contains("newColumn"))form.newColumn(table),event.stopPropagation();else if(action.contains("deleteColumn")&&(event.ctrlKey||confirm("it"===(window.navigator.userLanguage||window.navigator.language)?"Sicuri di voler eliminare la colonna?":"Are you sure you want to delete the column?"))){let e=table.querySelectorAll("thead>tr, tbody>tr"),t=event.target.closest("th").cellIndex;if(2==e[0].childElementCount)table.querySelector("tbody").innerHTML="";else for(let a=0;a<e.length;++a)e[a].removeChild(e[a].children[t]);let a=JSON.parse(form.jsonField.value||"{}");a[table.getAttribute("name")]&&(a[table.getAttribute("name")].splice(t-1,1),form.jsonField.value=JSON.stringify(a),form.jsonField.dispatchEvent(new Event("input"))),form.JSONStringify(event),event.stopPropagation()}})),form.formatText=e=>{let t=window.getSelection();if(e.target.dataset.format&&t&&t.rangeCount){let a=t.getRangeAt(0),r=document.createElement(e.target.dataset.format);r.innerHTML=a,r.setAttribute("title",Date().toLocaleString()),a.deleteContents(),a.insertNode(r)}else if("expand"==e.target.dataset.action&&document.activeElement.hasAttribute("contenteditable"))return void form.zoom(e,document.activeElement);e.preventDefault(),e.stopPropagation()}}