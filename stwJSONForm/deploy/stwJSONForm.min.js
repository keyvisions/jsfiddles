function JSONForm(){document.querySelectorAll("[data-json]").forEach((e=>{let t=e.form;if(t){t.jsonField=e,t.querySelectorAll('[form="json"]').forEach((e=>{e.classList.add("JSONData")})),t.hasAttribute("disabled")&&(t.querySelectorAll('button, input[type="button"], input[type="submit"], input[type="reset"]').forEach((e=>{e.style.display="none"})),t.querySelectorAll(".JSONData").forEach((e=>{"DIV"==e.tagName?e.removeAttribute("contenteditable"):"TABLE"==e.tagName||(e.disabled=!0,"disabled"==e.value&&(e.value=""))}))),t.newColumn=e=>{if(e.querySelector("tbody")||e.querySelector("tfoot.dataRow").insertAdjacentHTML("beforebegin","<tbody></tbody>"),e.querySelector("tbody").childElementCount){let t=e.querySelector("thead>tr>th:nth-child(2)").cloneNode(!0);e.querySelector("thead>tr>th").insertAdjacentElement("afterend",t);let o=e.querySelectorAll("tfoot.dataRow td");for(let t=0;t<o.length;++t)e.querySelector("tbody").children[t].appendChild(o[t].cloneNode(!0))}else e.querySelector("tbody").insertAdjacentHTML("afterbegin",e.querySelector("tfoot.dataRow").innerHTML)},t.JSONStringify=function(e,t){let o=e.currentTarget,a=JSON.parse(o.jsonField.value||"{}"),l=t||e.target;if(t=l.closest("table")&&l.closest("table").classList.contains("JSONData")?l.closest("table"):t){let e=t.getAttribute("name");if(a[e]=[],t.classList.contains("columnar")){for(let o=0;o<t.querySelectorAll("tbody>tr:first-child .JSONData[name]").length;++o)a[e].push({});t.querySelectorAll("tbody>tr").forEach((function(t,l){t.querySelectorAll(".JSONData[name]").forEach((function(t,l){a[e][l][t.getAttribute("name")]=o.valueStringify(t)}))}))}else t.querySelectorAll("tbody").forEach((t=>{let l={};t.querySelectorAll(".JSONData[name]").forEach((e=>{l[e.getAttribute("name")]=o.valueStringify(e)})),a[e].push(l)})),a[`${e}_summary`]={},t.querySelectorAll("tfoot output[for]").forEach((o=>{let l=0;t.querySelectorAll(`tbody input[name=${o.getAttribute("for")}]`).forEach((e=>l+=parseFloat(e.value)||0)),o.value=l,a[`${e}_summary`][o.getAttribute("for")]=l}));t.querySelector("tfoot.dataRow").onchange&&t.querySelector("tfoot.dataRow").onchange(t)}else a[l.getAttribute("name")]=o.valueStringify(l);o.jsonField.value=JSON.stringify(a)},t.valueStringify=e=>{let t;return"checkbox"!=e.type||null!=e.value&&"on"!=e.value?"checkbox"==e.type?(t=[],e.closest("fieldset").querySelectorAll("[type=checkbox]").forEach((e=>{e.checked&&t.push(e.value)}))):"select-multiple"==e.type?(t=[],e.querySelectorAll("option").forEach((e=>{e.selected&&t.push(e.value)}))):t=void 0!==e.value?e.value:e.innerHTML:(t=0,e.closest("fieldset")?e.closest("fieldset").querySelectorAll("[type=checkbox]").forEach((e=>{t=(t||0)<<1|e.checked})):t=e.checked),e.classList.add("modified"),t},t.JSONParse=e=>{let t,o=e.target.closest("form");try{t=JSON.parse(o.jsonField.value||"{}"),o.style.backgroundColor="inherit",o.title=""}catch(e){return o.style.backgroundColor="rgba(255,0,0,0.1)",void(o.title=e)}Object.keys(t).forEach((e=>{let a=o.querySelector('.JSONData[name="'+e+'"]');if(a&&"TABLE"==a.tagName&&a.classList.contains("JSONData"))if(a.hasAttribute("data-key")||a.querySelectorAll("tbody").forEach((e=>{e.remove()})),a.classList.contains("columnar")){a.querySelector("tfoot.dataRow").insertAdjacentHTML("beforebegin","<tbody></tbody>");let l=a.querySelectorAll(".deleteColumn");for(let e=l.length-1;e>0;--e)l[e].parentElement.removeChild(l[e]);for(let l=0;l<t[e].length;++l)o.newColumn(a);t[e].forEach((function(e,t){Object.keys(e).forEach((l=>{let r=a.querySelector(`tbody td:nth-child(${t+2}) .JSONData[name="${l}"]`);r&&o.parseValue(r,e[l])}))}))}else a.hasAttribute("data-key")?a.querySelectorAll("tbody[data-key]").forEach(((l,r)=>{let n=t[e].find((e=>e[a.getAttribute("data-key")]==l.getAttribute("data-key")))||{[a.getAttribute("data-key")]:l.getAttribute("data-key")},i=document.createElement("tbody");i.innerHTML=a.querySelector("tfoot.dataRow").innerHTML,i.querySelectorAll("td").forEach(((e,t)=>{""!=e.innerHTML&&(l.querySelector(`td:nth-child(${t+1})`).innerHTML=(0==t?`${r+1}.`:"")+e.innerHTML)})),Object.keys(n).forEach((e=>{let t=l.querySelector(`.JSONData[name="${e}"]`);t&&o.parseValue(t,n[e])}))})):t[e].forEach((e=>{let t=document.createElement("tbody");t.innerHTML=a.querySelector("tfoot.dataRow").innerHTML,Object.keys(e).forEach((a=>{let l=t.querySelector(`.JSONData[name="${a}"]`);l&&o.parseValue(l,e[a])})),a.querySelector("tfoot.dataRow").insertAdjacentElement("beforebegin",t)})),a.querySelectorAll("tfoot output[for]").forEach((e=>{let t=0;a.querySelectorAll(`tbody input[name=${e.getAttribute("for")}]`).forEach((e=>t+=parseFloat(e.value)||0)),e.value=t}));else o.parseValue(a,t[e])})),o.querySelectorAll("table.JSONData").forEach((e=>{e.querySelector("tfoot.dataRow").onchange&&e.querySelector("tfoot.dataRow").onchange(e)}));for(let e=0;e<o.childElementCount;++e){let a=o[e];a&&a.value&&void 0===t[a.getAttribute("name")]&&a.classList.contains("JSONData")&&o.JSONStringify({currentTarget:o,target:a})}},t.parseValue=function(e,t){!e||"TD"==e.tagName||"DIV"==e.tagName&&"true"==!e.contentEditable||("DIV"==e.tagName?e.innerHTML=t:"checkbox"==e.type||"radio"==e.type?e.closest("fieldset")?Array.isArray(t)?e.closest("fieldset").querySelectorAll("[type=checkbox]").forEach((e=>{e.checked=!!t.find((t=>t==e.value))})):"radio"==e.type?e.closest("fieldset").querySelectorAll("[type=radio]").forEach((e=>{e.checked=t==e.value})):e.closest("fieldset").querySelectorAll("[type=checkbox]").forEach((function(e,o){e.checked=!!((t||0)&1<<o)})):e.checked=!!t:"select-multiple"==e.type?e.querySelectorAll("option").forEach((e=>{t.find((t=>t==e.value))&&e.setAttribute("selected","")})):e.value=t)};try{JSON.parse(e.value),e.value||(e.value="{}")}catch(t){e.value="{}"}t.JSONParse({target:e}),t.zoom=function(e,t){t=t||e.target,"mousedown"!=e.type&&"F2"!=e.key||"TEXTAREA"!=t.tagName&&!t.hasAttribute("contenteditable")||(t.closest("label")?t.closest("label").classList.toggle("zoom"):t.classList.toggle("zoom"),t.blur(),t.focus(),e.stopPropagation(),e.preventDefault())},t.addEventListener("keydown",t.zoom),t.addEventListener("input",t.JSONStringify),t.addEventListener("click",(e=>{if(e.target.hasAttribute("contenteditable"))return void e.preventDefault();let o=e.target.closest("th")||e.target.closest("td");if(!o)return;let a=e.target.closest("table");if(o=o.classList,o.contains("newRow")&&(a.querySelector("tfoot").insertAdjacentHTML("beforeBegin","<tbody>"+a.querySelector("tfoot.dataRow").innerHTML+"</tbody>"),e.stopPropagation()),o.contains("deleteRow")&&confirm("Sicuri di voler eliminare la riga?")&&(e.target.closest("tbody").remove(),a.querySelector("tfoot.dataRow").onchange&&a.querySelector("tfoot.dataRow").onchange(a),t.JSONStringify(e,a),e.stopPropagation()),o.contains("newColumn")&&(t.newColumn(a),e.stopPropagation()),o.contains("deleteColumn")&&confirm("Sicuri di voler eliminare la colonna?")){let o=a.querySelectorAll("thead>tr, tbody>tr"),l=e.target.closest("th").cellIndex;if(2==o[0].childElementCount)a.querySelector("tbody").innerHTML="";else for(let e=0;e<o.length;++e)o[e].removeChild(o[e].children[l]);let r=JSON.parse(t.jsonField.value||"{}");r[a.getAttribute("name")]&&(r[a.getAttribute("name")].splice(l-1,1),t.jsonField.value=JSON.stringify(r)),t.JSONStringify(e),e.stopPropagation()}})),t.querySelectorAll("div[contenteditable]").forEach((e=>{"true"==e.getAttribute("contenteditable")&&(e.addEventListener("focus",(e=>{let o=document.getElementById("JSONToolbar");o||(document.body.insertAdjacentHTML("beforeend",'<div id="JSONToolbar"><i class="fas fa-fw fa-strikethrough" data-format="s" title="Barra testo selezionato"></i> <i class="fas fa-fw fa-highlighter" data-format="mark" title="Evidenzia testo selezionato"></i> <i class="fas fa-expand" data-action="expand" title="Zoom (F2)"></i></div>'),o=document.getElementById("JSONToolbar"),o.addEventListener("mousedown",t.formatText));let a=e.target.getBoundingClientRect();o.style.top=parseInt(a.top+window.scrollY+1)+"px",o.style.right=parseInt(window.innerWidth-a.right)+"px",o.style.display=""})),e.addEventListener("blur",(e=>{document.getElementById("JSONToolbar").style.display="none"})))})),t.formatText=e=>{let o=window.getSelection();if(e.target.dataset.format&&o&&o.rangeCount){let t=o.getRangeAt(0),a=document.createElement(e.target.dataset.format);a.innerHTML=t,a.setAttribute("title",Date().toLocaleString()),t.deleteContents(),t.insertNode(a)}else if("expand"==e.target.dataset.action&&document.activeElement.hasAttribute("contenteditable"))return void t.zoom(e,document.activeElement);e.preventDefault(),e.stopPropagation()}}}))}