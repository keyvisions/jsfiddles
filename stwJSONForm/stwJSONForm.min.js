function JSONForm(){document.querySelectorAll("[data-json]").forEach(a=>{let b=a.form;if(b){a.style.display="none",b.jsonField=a,b.querySelectorAll("[form=\"json\"]").forEach(a=>{a.classList.add("JSONData")}),b.hasAttribute("disabled")&&(b.querySelectorAll("button, input[type=\"button\"], input[type=\"submit\"], input[type=\"reset\"]").forEach(a=>{a.style.display="none"}),b.querySelectorAll(".JSONData").forEach(a=>{if("DIV"==a.tagName)a.removeAttribute("contenteditable");else if("TABLE"==a.tagName);else a.disabled=!0,"disabled"==a.value&&(a.value="")})),b.newColumn=a=>{if(a.querySelector("tbody")||a.querySelector("tfoot.dataRow").insertAdjacentHTML("beforebegin","<tbody></tbody>"),!a.querySelector("tbody").childElementCount)a.querySelector("tbody").insertAdjacentHTML("afterbegin",a.querySelector("tfoot.dataRow").innerHTML);else{let b=a.querySelector("thead>tr>th:nth-child(2)").cloneNode(!0);a.querySelector("thead>tr>th").insertAdjacentElement("afterend",b);let c=a.querySelectorAll("tfoot.dataRow td");for(let b=0;b<c.length;++b)a.querySelector("tbody").children[b].appendChild(c[b].cloneNode(!0))}},b.JSONStringify=function(a,b){let c=a.currentTarget,d=JSON.parse(c.jsonField.value||"{}"),e=b||a.target;if(b=e.closest("table")&&e.closest("table").classList.contains("JSONData")?e.closest("table"):b,b){let a=b.getAttribute("name");if(d[a]=[],b.classList.contains("columnar")){for(let c=0;c<b.querySelectorAll("tbody>tr:first-child .JSONData[name]").length;++c)d[a].push({});b.querySelectorAll("tbody>tr").forEach(function(b){b.querySelectorAll(".JSONData[name]").forEach(function(b,e){d[a][e][b.getAttribute("name")]=c.valueStringify(b)})})}else b.querySelectorAll("tbody").forEach(b=>{let e={};b.querySelectorAll(".JSONData[name]").forEach(a=>{e[a.getAttribute("name")]=c.valueStringify(a)}),d[a].push(e)}),d[`${a}_summary`]={},b.querySelectorAll(`tfoot output[for]`).forEach(c=>{let e=0;b.querySelectorAll(`tbody input[name=${c.getAttribute("for")}]`).forEach(a=>e+=parseFloat(a.value)||0),c.value=e,d[`${a}_summary`][c.getAttribute("for")]=e});b.querySelector("tfoot.dataRow").onchange&&b.querySelector("tfoot.dataRow").onchange(b)}else d[e.getAttribute("name")]=c.valueStringify(e);c.jsonField.value=JSON.stringify(d)},b.valueStringify=a=>{let b;return"checkbox"==a.type&&(null==a.value||"on"==a.value)?(b=0,a.closest("fieldset")?a.closest("fieldset").querySelectorAll("[type=checkbox]").forEach(a=>{b=(b||0)<<1|a.checked}):b=a.checked):"checkbox"==a.type?(b=[],a.closest("fieldset").querySelectorAll("[type=checkbox]").forEach(a=>{a.checked&&b.push(a.value)})):"select-multiple"==a.type?(b=[],a.querySelectorAll("option").forEach(a=>{a.selected&&b.push(a.value)})):b="undefined"==typeof a.value?a.innerHTML:a.value,a.classList.add("modified"),b},b.JSONParse=a=>{let b,d=a.target.closest("form");try{b=JSON.parse(d.jsonField.value||"{}"),d.style.backgroundColor="inherit",d.title=""}catch(a){return d.style.backgroundColor="rgba(255,0,0,0.1)",void(d.title=a)}Object.keys(b).forEach(a=>{let e=d.querySelector(".JSONData[name=\""+a+"\"]");if(!(e&&"TABLE"==e.tagName&&e.classList.contains("JSONData")))d.parseValue(e,b[a]);else if(e.hasAttribute("data-key")||e.querySelectorAll("tbody").forEach(a=>{a.remove()}),e.classList.contains("columnar")){e.querySelector("tfoot.dataRow").insertAdjacentHTML("beforebegin","<tbody></tbody>");let c=e.querySelectorAll(".deleteColumn");for(let a=c.length-1;0<a;--a)c[a].parentElement.removeChild(c[a]);for(let c=0;c<b[a].length;++c)d.newColumn(e);b[a].forEach(function(a,b){Object.keys(a).forEach(c=>{let f=e.querySelector(`tbody td:nth-child(${b+2}) .JSONData[name="${c}"]`);f&&d.parseValue(f,a[c])})})}else e.hasAttribute("data-key")?e.querySelectorAll("tbody[data-key]").forEach((c,f)=>{let g=b[a].find(a=>a[e.getAttribute("data-key")]==c.getAttribute("data-key"))||{[e.getAttribute("data-key")]:c.getAttribute("data-key")},h=document.createElement("tbody");h.innerHTML=e.querySelector("tfoot.dataRow").innerHTML,h.querySelectorAll("td").forEach((a,b)=>{""!=a.innerHTML&&(c.querySelector(`td:nth-child(${b+1})`).innerHTML=(0==b?`${f+1}.`:"")+a.innerHTML)}),Object.keys(g).forEach(a=>{let b=c.querySelector(`.JSONData[name="${a}"]`);b&&d.parseValue(b,g[a])})}):b[a].forEach(a=>{let b=document.createElement("tbody");b.innerHTML=e.querySelector("tfoot.dataRow").innerHTML,Object.keys(a).forEach(c=>{let e=b.querySelector(`.JSONData[name="${c}"]`);e&&d.parseValue(e,a[c])}),e.querySelector("tfoot.dataRow").insertAdjacentElement("beforebegin",b)}),e.querySelectorAll(`tfoot output[for]`).forEach(a=>{let b=0;e.querySelectorAll(`tbody input[name=${a.getAttribute("for")}]`).forEach(a=>b+=parseFloat(a.value)||0),a.value=b})}),d.querySelectorAll("table.JSONData").forEach(a=>{a.querySelector("tfoot.dataRow").onchange&&a.querySelector("tfoot.dataRow").onchange(a)});for(let c,e=0;e<d.childElementCount;++e)c=d[e],c&&c.value&&"undefined"==typeof b[c.getAttribute("name")]&&c.classList.contains("JSONData")&&d.JSONStringify({currentTarget:d,target:c})},b.parseValue=function(a,b){a&&"TD"!=a.tagName&&("DIV"!=a.tagName||"false"!=a.contentEditable)&&("DIV"==a.tagName?a.innerHTML=b:"checkbox"==a.type||"radio"==a.type?a.closest("fieldset")?Array.isArray(b)?a.closest("fieldset").querySelectorAll("[type=checkbox]").forEach(a=>{a.checked=!!b.find(b=>b==a.value)}):"radio"==a.type?a.closest("fieldset").querySelectorAll("[type=radio]").forEach(a=>{a.checked=b==a.value}):a.closest("fieldset").querySelectorAll("[type=checkbox]").forEach(function(a,c){a.checked=!!((b||0)&1<<c)}):a.checked=!!b:"select-multiple"==a.type?a.querySelectorAll("option").forEach(a=>{b.find(b=>b==a.value)&&a.setAttribute("selected","")}):a.value=b)};try{JSON.parse(a.value),a.value||(a.value="{}")}catch(b){a.value="{}"}b.JSONParse({target:a}),b.zoom=function(a,b){b=b||a.target,("mousedown"==a.type||"F2"==a.key)&&("TEXTAREA"==b.tagName||b.hasAttribute("contenteditable"))&&(b.closest("label")?b.closest("label").classList.toggle("zoom"):b.classList.toggle("zoom"),b.blur(),b.focus(),a.stopPropagation(),a.preventDefault())},b.addEventListener("keydown",b.zoom),b.addEventListener("input",b.JSONStringify),b.addEventListener("click",a=>{if(a.target.hasAttribute("contenteditable"))return void a.preventDefault();let c=a.target.closest("th")||a.target.closest("td");if(c){let d=a.target.closest("table");if(c=c.classList,c.contains("newRow")&&(d.querySelector("tfoot").insertAdjacentHTML("beforeBegin","<tbody>"+d.querySelector("tfoot.dataRow").innerHTML+"</tbody>"),a.stopPropagation()),c.contains("deleteRow")&&confirm("Sicuri di voler eliminare la riga?")&&(a.target.closest("tbody").remove(),d.querySelector("tfoot.dataRow").onchange&&d.querySelector("tfoot.dataRow").onchange(d),b.JSONStringify(a,d),a.stopPropagation()),c.contains("newColumn")&&(b.newColumn(d),a.stopPropagation()),c.contains("deleteColumn")&&confirm("Sicuri di voler eliminare la colonna?")){let c=d.querySelectorAll("thead>tr, tbody>tr"),e=a.target.closest("th").cellIndex;if(2==c[0].childElementCount)d.querySelector("tbody").innerHTML="";else for(let a=0;a<c.length;++a)c[a].removeChild(c[a].children[e]);let f=JSON.parse(b.jsonField.value||"{}");f[d.getAttribute("name")]&&(f[d.getAttribute("name")].splice(e-1,1),b.jsonField.value=JSON.stringify(f)),b.JSONStringify(a),a.stopPropagation()}}}),b.querySelectorAll("div[contenteditable]").forEach(a=>{a.addEventListener("focus",a=>{let c=document.getElementById("JSONToolbar");c||(document.body.insertAdjacentHTML("beforeend","<div id=\"JSONToolbar\"><i class=\"fas fa-fw fa-strikethrough\" data-format=\"s\" title=\"Barra testo selezionato\"></i> <i class=\"fas fa-fw fa-highlighter\" data-format=\"mark\" title=\"Evidenzia testo selezionato\"></i> <i class=\"fas fa-expand\" data-action=\"expand\" title=\"Zoom (F2)\"></i></div>"),c=document.getElementById("JSONToolbar"),c.addEventListener("mousedown",b.formatText));let d=a.target.getBoundingClientRect();c.style.top=parseInt(d.top+window.scrollY+1)+"px",c.style.right=parseInt(window.innerWidth-d.right)+"px",c.style.display=""}),a.addEventListener("blur",()=>{document.getElementById("JSONToolbar").style.display="none"})}),b.formatText=a=>{let c=window.getSelection();if(a.target.dataset.format&&c&&c.rangeCount){let b=c.getRangeAt(0),d=document.createElement(a.target.dataset.format);d.innerHTML=b,d.setAttribute("title",Date().toLocaleString()),b.deleteContents(),b.insertNode(d)}else if("expand"==a.target.dataset.action&&document.activeElement.hasAttribute("contenteditable"))return void b.zoom(a,document.activeElement);a.preventDefault(),a.stopPropagation()}}})}