class kvPair extends HTMLElement{static observedAttributes=["src","pair","labels"];constructor(){super(),this.addEventListener("click",this.#e),this.addEventListener("keydown",this.#e),this.addEventListener("focusout",this.#e),this.addEventListener("focusin",this.#e),this.innerHTML=`<menu role="list" data-bit="0"><label></label></menu><menu role="list" data-bit="1"><label></label></menu><input type="hidden" name="${this.getAttribute("name")||"kv-pair"}">`,this.removeAttribute("name"),this.children[0].addEventListener("scroll",this.#e),this.children[0].addEventListener("scrollend",this.#e),this.children[1].addEventListener("scroll",this.#e),this.children[1].addEventListener("scrollend",this.#e)}async#t(e){return await fetch(e).then((e=>e.json())).then((e=>e)).catch((()=>["",""]))}async attributeChangedCallback(e,t,l){if(t==l)return;if("pair"==e)return this.setAttribute("pair","true"==l?"true":"false"),void(this.children[1].style.display="true"==l?"":"none");if("labels"==e)return this.children[0].querySelector("label").innerText=l.split(",")[0],void(this.children[1].querySelector("label").innerText=l.split(",")[1]);const i="["==l[0]?JSON.parse(l):await this.#t(l),s=(i[0]||"").split(","),n=(i[1]||"").split(","),r=Math.max(s.length,n.length);for(;s.length<r;)s.push("");for(;n.length<r;)n.push("");const a=this.getAttribute("labels")?.split(",")||["",""];this.children[0].innerHTML=`<label>${a[0]?a[0]:""}</label>`+s.map((e=>`<div role="listitem" contenteditable>${e}</div>`)).join(""),this.children[1].innerHTML=`<label>${a[1]?a[1]:""}</label>`+n.map((e=>`<div role="listitem" contenteditable>${e}</div>`)).join(""),i[1]||(this.children[1].style.display="none"),this.#l()}#e(e){if(e.key){if(-1==["Enter",",","Tab","ArrowDown","ArrowUp"].indexOf(e.key))return;e.preventDefault()}if("focusin"==e.type||"focusout"==e.type&&null==e.relatedTarget)return void this.querySelectorAll(".selected").forEach((e=>e.className=""));let t=e.relatedTarget||e.target;"scroll"!=e.type&&"scrollend"!=e.type&&"MENU"==t.tagName&&(t=t.lastChild,t.focus());const l=t.closest("menu")||this.querySelector("menu"),i=this.closest("kv-pair").querySelector(`menu[data-bit="${"0"==l.dataset.bit?"1":"0"}"]`);if("scroll"==e.type||"scrollend"==e.type)return void(i.scrollTop=l.scrollTop);this.querySelectorAll(".selected").forEach((e=>e.className=""));let s=0;for(;t.previousElementSibling;t=t.previousElementSibling,++s);switch(e.key){case"ArrowDown":s=s<l.children.length-1?s+2:2;case"ArrowUp":s=s>1?s-1:l.children.length-1,this.#i(l.children[s]),i.children[s].className="selected";break;case"Tab":this.#i(i.children[s]),i.children[s].className="",l.children[s].className="selected";break;case"Enter":l.insertAdjacentHTML("beforeend",'<div role="listitem" contenteditable></div>'),i.insertAdjacentHTML("beforeend",'<div role="listitem" contenteditable></div>'),s=l.children.length-1,this.#i(l.children[s]),i.children[s].className="selected";break;default:s&&s<i.children.length&&(i.children[s].className="selected")}this.#l(),i.scrollTop=l.scrollTop}#i(e){e.focus();const t=document.getSelection(),l=document.createRange();l.selectNodeContents(e),t.removeAllRanges(),t.addRange(l)}#l(){this.children[2].value=JSON.stringify([[...this.children[0].querySelectorAll('[role="listitem"]')].map((e=>e.innerText.replaceAll("\n",""))).join(",").replace(/,+$/g,""),[...this.children[1].querySelectorAll('[role="listitem"]')].map((e=>e.innerText.replaceAll("\n",""))).join(",").replace(/,+$/g,"")])}}customElements.define("kv-pair",kvPair);